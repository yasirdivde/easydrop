<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no"
  />
  <title>EasyDrop · P2P WebRTC File Sharing</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
    rel="stylesheet"
  />

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

  <!-- QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    :root {
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --accent-primary: #10b981;
      --accent-secondary: #14b8a6;
    }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
        "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
      background: var(--bg-color);
      color: var(--text-primary);
      -webkit-tap-highlight-color: transparent;
    }
    .app-screen {
      display: none;
      animation: fadeIn 0.25s ease-out;
    }
    .app-screen.active {
      display: block;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .btn {
      transition: all 0.2s ease;
      border-radius: 0.75rem;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(
        45deg,
        var(--accent-primary),
        var(--accent-secondary)
      );
      color: #fff;
    }
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 1.25rem;
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
      animation: fadeIn 0.25s ease;
    }
    .chat-bubble-sent {
      background: linear-gradient(
        45deg,
        var(--accent-primary),
        var(--accent-secondary)
      );
      color: #fff;
      align-self: flex-end;
      border-radius: 1rem 1rem 0.25rem 1rem;
    }
    .chat-bubble-received {
      background: #e2e8f0;
      color: #1f2937;
      align-self: flex-start;
      border-radius: 1rem 1rem 1rem 0.25rem;
    }
    .progress-ring__circle {
      transition: stroke-dashoffset 0.35s;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* QR scanner corners */
    .qr-corners {
      pointer-events: none;
      position: absolute;
      inset: 0;
    }
    .qr-corner {
      position: absolute;
      width: 28px;
      height: 28px;
      border: 4px solid #10b981;
    }
    .qr-corner.tl {
      top: 10px;
      left: 10px;
      border-right: none;
      border-bottom: none;
    }
    .qr-corner.tr {
      top: 10px;
      right: 10px;
      border-left: none;
      border-bottom: none;
    }
    .qr-corner.bl {
      bottom: 10px;
      left: 10px;
      border-right: none;
      border-top: none;
    }
    .qr-corner.br {
      bottom: 10px;
      right: 10px;
      border-left: none;
      border-top: none;
    }

    /* Mobile save button */
    .save-name-btn {
      width: 2.5rem;
      height: 2.5rem;
    }
    @media (min-width: 640px) {
      .save-name-btn {
        width: 2.25rem;
        height: 2.25rem;
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto">
    <!-- Home Screen -->
    <div id="homeScreen" class="app-screen active p-4 md:p-6">
      <div class="text-center mb-8">
        <i class="fas fa-paper-plane text-5xl text-teal-500"></i>
        <h1 class="text-4xl font-bold text-slate-800 mt-2">EasyDrop</h1>
        <p class="text-slate-500">Simple, secure peer-to-peer file sharing</p>
      </div>

      <div class="bg-white rounded-3xl shadow-lg p-6 max-w-md mx-auto mb-8">
        <div
          class="w-24 h-24 rounded-full bg-green-100 flex items-center justify-center mb-4 mx-auto"
        >
          <i class="fas fa-user text-5xl text-green-500"></i>
        </div>

        <div
          class="flex items-center gap-2 justify-center flex-wrap sm:flex-nowrap"
        >
          <input
            id="deviceNameInput"
            type="text"
            class="text-xl font-bold text-center bg-transparent focus:bg-slate-100 rounded-lg p-2 outline-none min-w-[12rem]"
            value="Device-XXXX"
          />
          <button
            id="saveNameBtn"
            title="Save Name"
            class="btn bg-green-500 text-white rounded-full save-name-btn flex items-center justify-center flex-shrink-0"
          >
            <i class="fas fa-check"></i>
          </button>
        </div>

        <div
          id="connectionStatus"
          class="mt-4 bg-slate-100 text-slate-600 font-medium py-1 px-3 rounded-full inline-flex items-center gap-2 text-sm"
        >
          <i class="fas fa-circle text-gray-400"></i> <span>Waiting...</span>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl mx-auto">
        <!-- Direct -->
        <div class="bg-white rounded-3xl shadow-lg p-6">
          <h3 class="font-bold text-xl mb-4">
            <i class="fas fa-bolt text-purple-500 mr-2"></i>Direct Connect
          </h3>
          <div class="bg-slate-50 p-3 rounded-xl mb-4">
            <p class="text-xs text-slate-500 mb-1">Your Direct ID</p>
            <div class="flex items-center gap-2">
              <code
                id="myPeerId"
                class="flex-1 bg-slate-200 text-purple-700 font-bold p-2 rounded-lg break-all text-sm"
                >Initializing...</code
              >
              <button
                id="copyMyIdBtn"
                class="btn text-slate-600 w-10 h-10 flex items-center justify-center"
                title="Copy"
              >
                <i class="fas fa-copy"></i>
              </button>
              <button
                id="showMyIdQrBtn"
                class="btn text-slate-600 w-10 h-10 flex items-center justify-center"
                title="Show QR"
              >
                <i class="fas fa-qrcode"></i>
              </button>
            </div>
          </div>

          <input
            id="remotePeerIdInput"
            type="text"
            placeholder="Enter Peer’s Direct ID..."
            class="w-full border-2 border-slate-200 rounded-xl p-3 mb-3 focus:border-teal-500 outline-none transition"
          />
          <div class="flex gap-3">
            <button
              id="scanDirectBtn"
              class="btn bg-slate-700 text-white w-full py-3"
            >
              <i class="fas fa-camera mr-2"></i>Scan
            </button>
            <button id="connectDirectBtn" class="btn btn-primary w-full py-3">
              <i class="fas fa-link mr-2"></i>Connect
            </button>
          </div>
        </div>

        <!-- Room -->
        <div class="bg-white rounded-3xl shadow-lg p-6">
          <h3 class="font-bold text-xl mb-4">
            <i class="fas fa-users text-teal-500 mr-2"></i>Join a Room
          </h3>
          <input
            id="roomCodeInput"
            type="text"
            placeholder="Enter Room Code..."
            class="w-full border-2 border-slate-200 rounded-xl p-3 mb-3 focus:border-teal-500 outline-none transition"
          />
          <div class="flex gap-3 mb-3">
            <button
              id="scanRoomBtn"
              class="btn bg-slate-700 text-white w-full py-3"
            >
              <i class="fas fa-camera mr-2"></i>Scan
            </button>
            <button id="joinRoomBtn" class="btn btn-primary w-full py-3">
              <i class="fas fa-sign-in-alt mr-2"></i>Join
            </button>
          </div>
          <p class="text-center text-slate-400 my-2">or</p>
          <button id="createRoomBtn" class="btn btn-primary w-full py-3">
            <i class="fas fa-plus-circle mr-2"></i>Create New Room
          </button>
        </div>
      </div>
    </div>

    <!-- Transfer Screen -->
    <div id="transferWindow" class="app-screen p-4 md:p-6">
      <div
        id="transferHeader"
        class="rounded-3xl p-5 mb-6 text-white bg-gradient-to-r from-green-500 to-teal-500"
      ></div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 flex flex-col gap-6">
          <!-- Send files -->
          <div class="bg-white rounded-3xl shadow-lg p-6">
            <h3 id="sendFileTitle" class="text-xl font-bold text-center mb-4">
              Send Files
            </h3>
            <div
              id="dropZone"
              class="relative border-2 border-dashed border-slate-300 rounded-2xl p-8 text-center cursor-pointer hover:border-teal-400 hover:bg-teal-50 transition-all"
            >
              <i class="fas fa-cloud-upload-alt text-5xl text-slate-400 mb-4"></i>
              <p class="font-semibold text-slate-700">
                Drag & Drop files here
              </p>
              <p class="text-sm text-slate-500 my-2">or</p>
              <button
                id="browseBtn"
                type="button"
                class="btn btn-primary px-6 py-2.5 inline-flex items-center justify-center"
              >
                <i class="fas fa-folder-open mr-2"></i>Browse Files
              </button>
              <input id="fileInput" type="file" class="hidden" multiple />
            </div>
          </div>

          <!-- Transfer queue -->
          <div class="bg-white rounded-3xl shadow-lg p-6">
            <h3 class="text-xl font-bold mb-4">Transfer Queue</h3>
            <div id="fileQueue" class="space-y-3">
              <p class="text-slate-400 text-center py-4">
                No active transfers
              </p>
            </div>
          </div>
        </div>

        <!-- Right column -->
        <div class="flex flex-col gap-6">
          <!-- Peers (room only) -->
          <div
            id="peerListContainer"
            class="bg-white rounded-3xl shadow-lg p-6 hidden"
          >
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold">Connected Peers</h3>
              <button
                id="leaveRoomBtn"
                class="btn bg-white text-red-700 border border-red-200 px-3 py-2 hidden"
              >
                <i class="fas fa-door-open mr-2"></i>Leave Room
              </button>
            </div>
            <div
              id="peerList"
              class="space-y-2 max-h-48 overflow-y-auto no-scrollbar"
            ></div>
          </div>

          <!-- Chat -->
          <div
            class="bg-white rounded-3xl shadow-lg p-6 flex flex-col"
            style="min-height: 280px;"
          >
            <h3 id="chatTitle" class="text-xl font-bold mb-4">Chat</h3>
            <div
              id="chatMessages"
              class="flex-1 overflow-y-auto bg-slate-100 rounded-2xl p-3 flex flex-col gap-3 mb-4 no-scrollbar"
              style="max-height: 42vh;"
            ></div>
            <div class="flex gap-2">
              <input
                id="chatInput"
                type="text"
                class="flex-1 bg-slate-100 border-2 border-transparent rounded-xl p-3 focus:border-teal-500 outline-none transition"
                placeholder="Type message..."
              />
              <button
                id="sendChatBtn"
                class="btn btn-primary w-12 h-12 flex-shrink-0 text-xl"
              >
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>

          <!-- History (always last) -->
          <div id="historyContainer" class="bg-white rounded-3xl shadow-lg p-6">
            <h3 class="text-xl font-bold mb-4">Session History</h3>
            <div
              id="sessionHistory"
              class="space-y-2 max-h-48 overflow-y-auto no-scrollbar"
            >
              <p class="text-slate-400 text-center py-4">No events yet.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- QR Modal -->
    <div id="qrModal" class="modal">
      <div class="modal-content p-6 max-w-sm w-full mx-4 text-center">
        <h3 id="qrModalTitle" class="text-lg font-bold mb-4"></h3>
        <div
          id="qrcodeContainer"
          class="inline-block p-4 bg-white rounded-xl"
        ></div>
        <p
          id="qrCodeText"
          class="font-mono text-base my-3 p-2 bg-slate-100 rounded-lg break-all"
        ></p>
        <button id="closeQrBtn" class="btn bg-slate-200 text-slate-700 px-6 py-2 mt-2">
          Close
        </button>
      </div>
    </div>

    <!-- Scanner Modal -->
    <div id="qrScannerModal" class="modal">
      <div class="modal-content p-4 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-2 px-2">
          <h3 id="qrScannerTitle" class="text-lg font-bold"></h3>
          <button
            id="closeScannerBtn"
            class="text-slate-500 hover:text-slate-800 text-2xl w-10 h-10"
            title="Close"
          >
            &times;
          </button>
        </div>
        <div class="relative">
          <div
            id="qr-reader"
            class="rounded-2xl overflow-hidden w-full aspect-square bg-slate-900"
          ></div>
          <div class="qr-corners">
            <div class="qr-corner tl"></div>
            <div class="qr-corner tr"></div>
            <div class="qr-corner bl"></div>
            <div class="qr-corner br"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Receive Modal -->
    <div id="fileReceiveModal" class="modal">
      <div class="modal-content p-6 max-w-sm w-full mx-4">
        <div class="text-center mb-4">
          <div
            class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 ring-8 ring-green-50"
          >
            <i class="fas fa-file-download text-4xl text-green-500"></i>
          </div>
          <h3 class="text-xl font-bold">Incoming File</h3>
          <p id="fileReceiveSubtext" class="text-sm text-slate-500"></p>
        </div>

        <div class="bg-slate-100 rounded-xl p-4 mb-4 flex items-center gap-4">
          <i id="fileReceiveIcon" class="fas fa-file text-4xl text-green-500"></i>
          <div class="flex-1 min-w-0">
            <p id="fileReceiveName" class="font-bold truncate"></p>
            <p id="fileReceiveSize" class="text-sm text-slate-500"></p>
            <p id="fileReceiveFrom" class="text-xs text-slate-400 mt-0.5"></p>
          </div>
        </div>

        <div class="flex gap-3">
          <button id="declineBtn" class="btn bg-slate-200 text-slate-700 w-full py-3">
            <i class="fas fa-times mr-2"></i>Decline
          </button>
          <button id="acceptBtn" class="btn btn-primary w-full py-3">
            <i class="fas fa-check mr-2"></i>Accept
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    /* ---------- Utilities ---------- */
    const $ = (id) => document.getElementById(id);

    function notify(message, type = "info") {
      const colors = {
        success: "bg-green-100 text-green-700 border-green-500",
        error: "bg-red-100 text-red-700 border-red-500",
        warning: "bg-yellow-100 text-yellow-700 border-yellow-500",
        info: "bg-teal-100 text-teal-700 border-teal-500",
      };
      const icons = {
        success: "fa-check-circle",
        error: "fa-exclamation-circle",
        warning: "fa-info-circle",
        info: "fa-info-circle",
      };
      const n = document.createElement("div");
      n.className = \`fixed top-5 right-5 border-l-4 p-4 rounded-xl shadow-lg z-[9999] max-w-sm \${colors[type]} transition-all duration-300 transform translate-x-full opacity-0\`;
      n.innerHTML = \`
        <div class="flex items-center">
          <i class="fas \${icons[type]} text-xl mr-3"></i>
          <p class="font-medium">\${message}</p>
        </div>\`;
      document.body.appendChild(n);
      requestAnimationFrame(() => {
        n.classList.remove("translate-x-full", "opacity-0");
      });
      setTimeout(() => {
        n.classList.add("translate-x-full", "opacity-0");
        n.addEventListener("transitionend", () => n.remove(), { once: true });
      }, 3000);
    }

    function formatBytes(b) {
      if (!b && b !== 0) return "0 Bytes";
      const k = 1024, sizes = ["Bytes", "KB", "MB", "GB", "TB"];
      const i = Math.floor(Math.log(b) / Math.log(k));
      return \`\${parseFloat((b / Math.pow(k, i)).toFixed(2))} \${sizes[i]}\`;
    }

    let audioContext = null;
    window.addEventListener(
      "click",
      () => {
        if (!audioContext)
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
      },
      { once: true }
    );
    function beep(kind = "info") {
      if (!audioContext) return;
      const o = audioContext.createOscillator();
      const g = audioContext.createGain();
      o.connect(g);
      g.connect(audioContext.destination);
      o.frequency.value = kind === "error" ? 220 : kind === "complete" ? 880 : 440;
      g.gain.setValueAtTime(0.2, audioContext.currentTime);
      g.gain.exponentialRampToValueAtTime(
        1e-4,
        audioContext.currentTime + 0.25
      );
      o.start();
      o.stop(audioContext.currentTime + 0.25);
    }

    /* ---------- State ---------- */
    let peer = null;
    let myPeerId = null;
    let preferredPeerId = null;
    let peerReadyResolve = null;
    let isPeerReady = false;
    const peerReady = new Promise((res) => (peerReadyResolve = res));

    let myDeviceName = null;
    let connectionMode = null; // "direct" | "room"
    let roomCode = null;
    let isHost = false;

    const connections = {}; // peerId -> DataConnection

    const pendingReceives = new Map(); // id -> { meta, conn, chunks[], receivedSize, start }
    const cancelledReceives = new Set(); // ids cancelled by sender

    const sendQueue = []; // [{ baseId, file }]
    let currentSend = null;

    // Throughput tuning
    const CHUNK_SIZE = 256 * 1024; // 256 KB
    const WINDOW_SIZE = 64; // in-flight packets per recipient

    // Sender per-recipient state
    const sendStates = new Map(); // key(baseId::peerId) -> { baseId, peerId, file, conn, start, nextIndex, totalChunks, inFlight, ackedBytes }
    const groupSendTracker = new Map(); // baseId -> { targets:Set, accepted:Set, rejected:Set, completed:Set }

    // QR
    let html5QrCode = null;
    let qrScannerMode = null; // "direct" | "room"
    let qrScanLocked = false;

    /* ---------- Elements ---------- */
    const homeScreen = $("homeScreen");
    const transferWindow = $("transferWindow");
    const transferHeader = $("transferHeader");
    const sendFileTitle = $("sendFileTitle");
    const chatTitle = $("chatTitle");

    const deviceNameInput = $("deviceNameInput");
    const saveNameBtn = $("saveNameBtn");
    const connectionStatus = $("connectionStatus");

    const myPeerIdEl = $("myPeerId");
    const copyMyIdBtn = $("copyMyIdBtn");
    const showMyIdQrBtn = $("showMyIdQrBtn");

    const remotePeerIdInput = $("remotePeerIdInput");
    const connectDirectBtn = $("connectDirectBtn");
    const scanDirectBtn = $("scanDirectBtn");

    const roomCodeInput = $("roomCodeInput");
    const joinRoomBtn = $("joinRoomBtn");
    const createRoomBtn = $("createRoomBtn");
    const scanRoomBtn = $("scanRoomBtn");
    const leaveRoomBtn = $("leaveRoomBtn");

    const dropZone = $("dropZone");
    const browseBtn = $("browseBtn");
    const fileInput = $("fileInput");
    const fileQueue = $("fileQueue");

    const peerListContainer = $("peerListContainer");
    const peerList = $("peerList");

    const sessionHistory = $("sessionHistory");
    const chatMessages = $("chatMessages");
    const chatInput = $("chatInput");
    const sendChatBtn = $("sendChatBtn");

    const qrModal = $("qrModal");
    const qrModalTitle = $("qrModalTitle");
    const qrcodeContainer = $("qrcodeContainer");
    const qrCodeText = $("qrCodeText");
    const closeQrBtn = $("closeQrBtn");

    const qrScannerModal = $("qrScannerModal");
    const qrScannerTitle = $("qrScannerTitle");
    const closeScannerBtn = $("closeScannerBtn");

    const fileReceiveModal = $("fileReceiveModal");
    const fileReceiveSubtext = $("fileReceiveSubtext");
    const fileReceiveIcon = $("fileReceiveIcon");
    const fileReceiveName = $("fileReceiveName");
    const fileReceiveSize = $("fileReceiveSize");
    const fileReceiveFrom = $("fileReceiveFrom");
    const acceptBtn = $("acceptBtn");
    const declineBtn = $("declineBtn");

    /* ---------- Peer config ---------- */
    const peerConfig = {
      config: {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:global.stun.twilio.com:3478" },
        ],
      },
    };

    /* ---------- Init ---------- */
    window.addEventListener("load", initialize);
    window.addEventListener("beforeunload", (e) => {
      if (isSendingActive()) {
        e.preventDefault();
        e.returnValue = "";
      }
    });

    function initialize() {
      loadDeviceName();
      bindUI();
      preferredPeerId = genId();
      myPeerIdEl.textContent = preferredPeerId;
      setupPeer(preferredPeerId);
    }

    function genId() {
      return "EZ-" + Math.random().toString(36).slice(2, 10).toUpperCase();
    }

    function loadDeviceName() {
      const saved = localStorage.getItem("deviceName");
      myDeviceName =
        saved || "Device-" + Math.random().toString(36).slice(2, 8).toUpperCase();
      deviceNameInput.value = myDeviceName;
    }

    function bindUI() {
      saveNameBtn.addEventListener("click", () => {
        const name = deviceNameInput.value.trim();
        if (name && name !== myDeviceName) {
          myDeviceName = name;
          localStorage.setItem("deviceName", name);
          notify("Device name saved!", "success");
        }
      });

      copyMyIdBtn.addEventListener("click", async () => {
        const id = myPeerId || preferredPeerId;
        if (id) {
          await navigator.clipboard.writeText(id);
          notify("Direct ID copied!", "success");
        }
      });

      showMyIdQrBtn.addEventListener("click", showMyIdQr);

      connectDirectBtn.addEventListener("click", connectDirect);
      scanDirectBtn.addEventListener("click", () => openQRScanner("direct"));

      createRoomBtn.addEventListener("click", createRoom);
      joinRoomBtn.addEventListener("click", joinRoom);
      scanRoomBtn.addEventListener("click", () => openQRScanner("room"));

      closeQrBtn.addEventListener("click", closeQR);
      closeScannerBtn.addEventListener("click", closeQRScanner);

      leaveRoomBtn.addEventListener("click", tryLeaveRoom);

      sendChatBtn.addEventListener("click", sendChatMessage);
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendChatMessage();
      });

      // Drag & drop
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add("border-teal-400", "bg-teal-50");
      });
      dropZone.addEventListener("dragleave", (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove("border-teal-400", "bg-teal-50");
      });
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove("border-teal-400", "bg-teal-50");
        if (e.dataTransfer.files?.length) queueFilesForTransfer(e.dataTransfer.files);
      });

      // Single-tap browse (prevent double dialogs)
      browseBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        fileInput.click();
      });
      dropZone.addEventListener("click", (e) => {
        if (e.target.closest("#browseBtn")) return;
        fileInput.click();
      });
      fileInput.addEventListener("change", (e) => {
        if (e.target.files?.length) queueFilesForTransfer(e.target.files);
        e.target.value = "";
      });

      // Host actions (kick buttons in peer list)
      peerList.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-kick]");
        if (btn) {
          const pid = btn.getAttribute("data-kick");
          kickPeer(pid);
        }
      });
    }

    /* ---------- Peer setup ---------- */
    function setupPeer(customId) {
      try {
        if (peer) peer.destroy();
      } catch {}
      peer = customId ? new Peer(customId, peerConfig) : new Peer(peerConfig);

      peer.on("open", (id) => {
        myPeerId = id;
        isPeerReady = true;
        if (peerReadyResolve) peerReadyResolve(true);
        myPeerIdEl.textContent = id;
        updateStatus("Online", "green");
      });

      peer.on("connection", (conn) => {
        // Infer mode when unknown
        if (!connectionMode) {
          connectionMode = conn?.metadata?.mode || "direct";
          roomCode = conn?.metadata?.roomCode || roomCode || null;
          isHost = !!roomCode && myPeerId === roomCode;
        }
        handleConnection(conn);
      });

      peer.on("error", (err) => {
        if (String(err?.type || "").includes("unavailable-id")) {
          preferredPeerId = genId();
          myPeerIdEl.textContent = preferredPeerId;
          setupPeer(preferredPeerId);
          return;
        }
        notify("Connection error.", "error");
        updateStatus("Error", "red");
      });

      peer.on("disconnected", () => {
        updateStatus("Reconnecting...", "orange");
      });
    }

    function awaitPeerReady(fn) {
      if (isPeerReady) return fn();
      peerReady.then(fn);
    }

    function updateStatus(text, color) {
      const colors = {
        green: "text-green-500",
        red: "text-red-500",
        orange: "text-orange-500",
        gray: "text-gray-400",
      };
      connectionStatus.innerHTML = \`
        <i class="fas fa-circle \${colors[color] || colors.gray}"></i>
        <span>\${text}</span>\`;
    }

    /* ---------- Connect modes ---------- */
    function connectDirect() {
      connectionMode = "direct";
      isHost = false;
      const remoteId = remotePeerIdInput.value.trim();
      if (!remoteId) {
        notify("Please enter a Direct ID.", "warning");
        return;
      }
      if (!/^EZ-[A-Z0-9]{6,}$/.test(remoteId)) {
        notify("Invalid Direct ID format.", "error");
        return;
      }
      if (remoteId === (myPeerId || preferredPeerId)) {
        notify("Cannot connect to yourself.", "error");
        return;
      }
      awaitPeerReady(() => {
        const conn = peer.connect(remoteId, {
          reliable: true,
          metadata: { deviceName: myDeviceName, mode: "direct" },
        });
        handleConnection(conn);
      });
    }

    function createRoom() {
      connectionMode = "room";
      isHost = true;
      roomCode = Math.random().toString(36).toUpperCase().slice(2, 10);
      setupPeer(roomCode);
      showTransferWindow(); // Do not close QR modal if open (host may open it next)
    }

    let isJoiningRoom = false;
    function joinRoom() {
      if (isJoiningRoom) return;
      const code = roomCodeInput.value.trim().toUpperCase();
      if (!code) {
        notify("Please enter a room code.", "warning");
        return;
      }
      if (/^EZ-/.test(code)) {
        notify("Invalid Room Code format.", "error");
        return;
      }
      connectionMode = "room";
      isHost = false;
      roomCode = code;
      isJoiningRoom = true;
      awaitPeerReady(() => {
        const conn = peer.connect(roomCode, {
          reliable: true,
          metadata: { deviceName: myDeviceName, mode: "room", roomCode },
        });
        handleConnection(conn);
        setTimeout(() => (isJoiningRoom = false), 400);
      });
    }

    function tryLeaveRoom() {
      if (connectionMode !== "room") {
        location.reload();
        return;
      }
      if (isSendingActive()) {
        notify("Cannot leave while a transfer is in progress.", "warning");
        return;
      }
      if (isHost) {
        // Close room for everyone
        broadcast({ type: "room-closed" });
        setTimeout(() => {
          for (const c of Object.values(connections)) {
            try {
              c.close();
            } catch {}
          }
          location.reload();
        }, 200);
      } else {
        // Just leave
        for (const c of Object.values(connections)) {
          try {
            c.close();
          } catch {}
        }
        setTimeout(() => location.reload(), 200);
      }
    }

    /* ---------- Connection lifecycle ---------- */
    function handleConnection(conn) {
      conn.on("open", () => {
        connections[conn.peer] = conn;

        // Sync metadata both ways
        conn.send({
          type: "metadata-sync",
          deviceName: myDeviceName,
          mode: connectionMode,
          roomCode,
        });

        // Show transfer window without auto-closing host's room QR
        showTransferWindow();
        updatePeerListUI();
      });

      conn.on("data", (data) => routeData(data, conn));

      conn.on("close", () => {
        delete connections[conn.peer];
        updatePeerListUI();
        if (connectionMode === "direct") {
          notify("Peer disconnected.", "info");
          setTimeout(() => location.reload(), 600);
        } else {
          notify(
            \`\${conn.metadata?.deviceName || "A peer"} left the room.\`,
            "info"
          );
        }
      });

      conn.on("error", () => {
        notify("A connection failed.", "error");
      });
    }

    function broadcast(payload, excludePeerId = null) {
      Object.values(connections).forEach((c) => {
        if (c && c.open && c.peer !== excludePeerId) c.send(payload);
      });
    }

    function routeData(data, conn) {
      if (!data || typeof data.type !== "string") return;
      switch (data.type) {
        case "metadata-sync":
          if (connections[conn.peer]) {
            connections[conn.peer].metadata = {
              ...(connections[conn.peer].metadata || {}),
              deviceName: data.deviceName,
            };
          }
          if (!connectionMode) connectionMode = data.mode || connectionMode;
          if (!roomCode) roomCode = data.roomCode || roomCode;
          updatePeerListUI();
          showTransferWindow();
          break;

        case "room-closed":
          notify("Room closed by host.", "warning");
          setTimeout(() => location.reload(), 600);
          break;

        case "room-kick":
          if (data.peerId && data.peerId !== myPeerId) return;
          if (isSendingActive()) {
            // Cannot be kicked while sending
            conn.send({ type: "kick-denied-sending", peerId: myPeerId });
            notify("Kick denied: transfer in progress.", "warning");
            return;
          }
          notify("You have been removed by the host.", "warning");
          setTimeout(() => {
            for (const c of Object.values(connections)) {
              try {
                c.close();
              } catch {}
            }
            location.reload();
          }, 400);
          break;

        case "kick-denied-sending":
          if (isHost) {
            notify("Cannot kick: user is sending a file.", "warning");
          }
          break;

        // Chat
        case "chat-message":
          displayChatMessage(data);
          beep("info");
          break;

        // File transfer
        case "file-request":
          onFileRequest(data, conn);
          break;
        case "file-accepted":
          onFileAccepted(data, conn);
          break;
        case "file-rejected":
          onFileRejected(data, conn);
          break;
        case "file-chunk":
          onFileChunk(data, conn);
          break;
        case "file-ack":
          onAck(data, conn);
          break;
        case "file-cancel":
          onFileCancel(data, conn);
          break;
      }
    }

    /* ---------- UI switching ---------- */
    function showTransferWindow() {
      // Keep host's room QR modal open when peers join
      const shouldKeepRoomQrOpen =
        connectionMode === "room" &&
        isHost &&
        qrModal.classList.contains("show");

      if (!shouldKeepRoomQrOpen) closeQR();

      homeScreen.classList.remove("active");
      homeScreen.classList.add("hidden");
      transferWindow.classList.remove("hidden");
      transferWindow.classList.add("active");

      if (connectionMode === "direct") {
        const remote = Object.values(connections)[0];
        const peerName = remote?.metadata?.deviceName || "Peer";
        transferHeader.innerHTML = \`
          <div class="flex items-center justify-between">
            <button class="btn bg-white/20 text-white w-12 h-12 text-xl" onclick="location.reload()">
              <i class="fas fa-arrow-left"></i>
            </button>
            <div class="text-right">
              <h2 class="font-bold text-xl">Connected to \${peerName}</h2>
              <p class="opacity-80 text-xs font-mono">\${remote?.peer || ""}</p>
            </div>
          </div>\`;
        peerListContainer.classList.add("hidden");
        sendFileTitle.textContent = "Send Files";
        chatTitle.textContent = "Direct Chat";
      } else {
        transferHeader.innerHTML = \`
          <div class="flex items-center justify-between">
            <button class="btn bg-white/20 text-white w-12 h-12 text-xl" onclick="tryLeaveRoom()">
              <i class="fas fa-arrow-left"></i>
            </button>
            <div class="text-center flex-1">
              <h2 class="font-bold text-xl">Room Code</h2>
              <p class="font-mono bg-white/20 px-2 py-1 rounded inline-block">\${roomCode || ""}</p>
            </div>
            <button class="btn bg-white/20 text-white w-12 h-12 text-xl" onclick="showRoomQr()">
              <i class="fas fa-qrcode"></i>
            </button>
          </div>\`;
        peerListContainer.classList.remove("hidden");
        leaveRoomBtn.classList.remove("hidden");
        sendFileTitle.textContent = "Send Files to Room";
        chatTitle.textContent = "Room Chat";
      }

      updatePeerListUI();
    }

    function updatePeerListUI() {
      if (connectionMode !== "room") return;

      let html =
