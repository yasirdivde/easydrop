<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>EasyDrop P2P — WebRTC File Sharing</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome (icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <!-- qrcode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    /* --- Base Styles & Fonts --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    :root {
        --bg-color: #f0f4f8;
        --card-bg: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --primary-accent: #4f46e5;
        --primary-accent-hover: #4338ca;
        --secondary-accent: #8b5cf6;
    }
    body {
        font-family: 'Inter', sans-serif;
        -webkit-tap-highlight-color: transparent;
        background-color: var(--bg-color);
        color: var(--text-primary);
    }

    /* --- App Layout --- */
    .app-screen {
        display: none;
        animation: slideInUp 0.6s cubic-bezier(0.25, 1, 0.5, 1);
    }
    .app-screen.active {
        display: block;
    }
    @media (min-width: 1024px) {
        #homeScreen.active { display: grid; }
        #transferWindow.active { display: block; }
        .app-screen { animation: fadeIn 0.5s ease-in-out; }
    }

    /* --- Animations --- */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes subtlePulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
    }
    .animate-subtle-pulse {
        animation: subtlePulse 2s infinite;
    }

    /* --- Component Styles --- */
    .app-card {
        background-color: var(--card-bg);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
    }
    .app-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    .btn {
        transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    }
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    .btn:active {
        transform: translateY(0);
        box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
    }
    .btn-primary {
        background: linear-gradient(to right, var(--primary-accent), var(--secondary-accent));
        color: white;
    }
    .btn-primary:hover {
       filter: brightness(1.1);
    }

    /* --- Glassmorphism --- */
    .glassmorphic {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .modal { background: rgba(0,0,0,0.3); } /* remove backdrop from modal itself */

    /* --- Bottom Navigation (Mobile) --- */
    .bottom-nav {
        border-top: 1px solid rgba(0,0,0,0.05);
    }
    .nav-btn {
        transition: all 0.2s ease;
    }
    .nav-btn.active svg { color: var(--primary-accent); }
    .nav-btn.active span { color: var(--primary-accent); }
    .nav-btn.active { transform: translateY(-3px); }
    .nav-btn svg {
        width: 28px;
        height: 28px;
        transition: all 0.2s ease;
    }
    
    /* --- Queue Item --- */
    .queue-item .progress-bar-bg {
        background-color: #e5e7eb;
    }
    .queue-item .progress-bar {
        background: linear-gradient(to right, #a5b4fc, var(--primary-accent));
        transition: width 0.4s ease;
    }
    
  </style>
</head>
<body class="bg-slate-100 text-slate-800">

  <!-- Main App Container -->
  <div id="appContainer" class="pb-24 lg:pb-0">

    <!-- Home Screen -->
    <div id="homeScreen" class="app-screen active container mx-auto px-4 py-6 max-w-6xl lg:grid lg:grid-cols-2 lg:gap-8">
        <div class="lg:col-span-2 text-center mb-8">
          <div class="flex items-center justify-center mb-3 gap-3">
            <i class="fas fa-paper-plane text-5xl text-indigo-600"></i>
            <h1 class="text-5xl font-extrabold text-slate-800">EasyDrop</h1>
          </div>
          <p class="text-lg text-slate-500">Simple, direct, and unlimited file sharing.</p>
        </div>

        <div class="lg:col-span-2 text-center mb-8">
            <div class="inline-flex items-center gap-2 justify-center flex-wrap bg-white p-2 rounded-full shadow-md">
                <span class="text-sm text-slate-500 pl-2">Device Name:</span>
                <input id="deviceNameInput" type="text"
                       class="text-base font-bold text-indigo-600 bg-transparent focus:bg-slate-100 px-3 py-1 rounded-full outline-none max-w-[150px] md:max-w-xs transition"
                       value="Device-XXXX"/>
                <button id="saveNameBtn" class="btn bg-indigo-500 text-white w-9 h-9 rounded-full hover:bg-indigo-600" title="Save Name">
                  <i class="fas fa-check"></i>
                </button>
            </div>
            <div class="mt-4">
              <span id="connectionStatus" class="text-sm text-slate-500 transition-colors font-medium">
                <i class="fas fa-circle text-gray-400 mr-1"></i> Waiting for PeerJS...
              </span>
            </div>
        </div>

      <!-- Direct Connection Card -->
      <div class="app-card bg-white rounded-2xl shadow-lg p-6 mb-6 lg:mb-0">
        <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-3">
          <i class="fas fa-user text-purple-600"></i>Direct Connection
        </h3>
        <div class="bg-slate-50 rounded-lg p-3 mb-4">
          <p class="text-xs text-slate-600 mb-1">Your Direct ID</p>
          <div class="flex items-center gap-2">
            <code id="myPeerId" class="flex-1 text-sm font-mono font-bold text-purple-700 bg-slate-200 px-3 py-2 rounded break-all">Initializing...</code>
            <button id="copyMyIdBtn" class="btn text-purple-600 hover:text-purple-700 text-xl" title="Copy ID"><i class="fas fa-copy"></i></button>
            <button id="showMyIdQrBtn" class="btn text-purple-600 hover:text-purple-700 text-xl" title="Show QR"><i class="fas fa-qrcode"></i></button>
          </div>
        </div>
        <div class="flex flex-col gap-3">
          <input id="remotePeerIdInput" type="text" placeholder="Enter Peer’s Direct ID..." class="w-full border border-slate-300 rounded-lg px-4 py-3 transition focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200"/>
          <div class="grid grid-cols-2 gap-3">
            <button id="scanDirectBtn" class="btn w-full bg-slate-700 text-white px-4 py-3 rounded-lg hover:bg-slate-800">
              <i class="fas fa-camera mr-2"></i>Scan
            </button>
            <button id="connectDirectBtn" class="btn w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700">
              <i class="fas fa-link mr-2"></i>Connect
            </button>
          </div>
        </div>
      </div>

      <!-- Room Connection Card -->
      <div class="app-card bg-white rounded-2xl shadow-lg p-6">
        <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-3">
          <i class="fas fa-users text-indigo-600"></i>Rooms
        </h3>
        <div class="flex flex-col gap-3">
          <input id="roomCodeInput" type="text" placeholder="Enter Room Code..." class="w-full border border-slate-300 rounded-lg px-4 py-3 transition focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200"/>
          <div class="grid grid-cols-2 gap-3">
            <button id="scanRoomBtn" class="btn w-full bg-slate-700 text-white px-4 py-3 rounded-lg hover:bg-slate-800">
              <i class="fas fa-camera mr-2"></i>Scan
            </button>
            <button id="joinRoomBtn" class="btn w-full bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700">
              <i class="fas fa-sign-in-alt mr-2"></i>Join
            </button>
          </div>
        </div>
        <div class="text-center my-4 text-slate-400 text-sm font-semibold">OR</div>
        <button id="createRoomBtn" class="btn btn-primary w-full px-6 py-3 rounded-lg animate-subtle-pulse">
          <i class="fas fa-plus-circle mr-2"></i>Create New Room
        </button>
      </div>
    </div>

    <!-- Transfer Screen -->
    <div id="transferWindow" class="app-screen container mx-auto px-4 py-6 max-w-7xl">
      <div id="transferHeader" class="p-5 mb-6 text-white"></div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 flex flex-col gap-6">
          <div class="app-card bg-white rounded-2xl shadow-lg p-6">
            <h3 id="sendFileTitle" class="text-xl font-bold text-slate-800 mb-4 text-center"></h3>
            <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-xl p-10 text-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 transition-all">
              <i class="fas fa-cloud-upload-alt text-5xl text-slate-400 mb-4"></i>
              <p class="text-lg text-slate-700 mb-1">Drag & Drop files here</p>
              <p class="text-sm text-slate-500 mb-4">or</p>
              <label for="fileInput" class="btn btn-primary px-6 py-3 rounded-lg cursor-pointer inline-block">
                <i class="fas fa-folder-open mr-2"></i>Browse Files
              </label>
              <input id="fileInput" type="file" class="hidden" multiple />
            </div>
          </div>
          <div class="app-card bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4"><i class="fas fa-stream text-indigo-600 mr-2"></i>Transfer Queue</h3>
            <div id="fileQueue"><p class="text-sm text-slate-400 text-center py-4">No active transfers</p></div>
          </div>
        </div>
        <div class="flex flex-col gap-6">
          <div id="peerListContainer" class="app-card bg-white rounded-2xl shadow-lg p-6 hidden">
            <h3 class="text-lg font-bold text-slate-800 mb-4"><i class="fas fa-user-friends text-purple-600 mr-2"></i>Connected Peers</h3>
            <div id="peerList" class="space-y-2 max-h-40 overflow-y-auto"></div>
          </div>
          <div class="app-card bg-white rounded-2xl shadow-lg p-6 flex flex-col" style="height: 50vh; min-height: 350px;">
            <h3 id="chatTitle" class="text-lg font-bold text-slate-800 mb-4"></h3>
            <div id="chatMessages" class="flex-1 overflow-y-auto bg-slate-100 rounded-lg p-3 flex flex-col gap-3 mb-4"></div>
            <div class="flex gap-2">
              <input id="chatInput" type="text" class="flex-1 border border-slate-300 rounded-lg px-4 py-2 transition focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" placeholder="Type a message..."/>
              <button id="sendChatBtn" class="btn bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600"><i class="fas fa-paper-plane"></i></button>
            </div>
          </div>
          <div class="app-card bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4"><i class="fas fa-history text-purple-600 mr-2"></i>Session History</h3>
            <div id="sessionHistory" class="space-y-2 max-h-60 overflow-y-auto"><p class="text-sm text-slate-400 text-center py-4">No events yet</p></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation (Mobile) -->
  <div id="bottomNav" class="fixed bottom-0 left-0 right-0 h-20 flex justify-around items-center lg:hidden bottom-nav glassmorphic">
      <button id="navHomeBtn" class="nav-btn active flex flex-col items-center gap-1 text-slate-600">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" /></svg>
          <span class="text-xs font-bold">Home</span>
      </button>
      <button id="navTransferBtn" class="nav-btn flex flex-col items-center gap-1 text-slate-600">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M17,17.5L12,20L7,17.5V14.5L12,17L17,14.5V17.5M12,2L1,9L12,16L23,9L12,2M12,4.5L19.5,9L12,13.5L4.5,9L12,4.5Z" /></svg>
          <span class="text-xs font-bold">Transfer</span>
      </button>
  </div>


  <!-- Modals -->
  <div id="qrModal" class="modal">
    <div class="modal-content glassmorphic rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4 text-center border-0">
      <h3 id="qrModalTitle" class="text-lg font-bold text-slate-800 mb-4"></h3>
      <div id="qrcodeContainer" class="inline-block p-4 bg-white rounded-lg ring-1 ring-slate-200"></div>
      <p id="qrCodeText" class="font-mono text-lg my-2 break-all"></p>
      <button id="closeQrBtn" class="mt-4 bg-slate-200 text-slate-700 px-6 py-2 rounded-lg btn">Close</button>
    </div>
  </div>

  <div id="qrScannerModal" class="modal">
    <div class="modal-content glassmorphic rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 border-0">
      <div class="flex justify-between items-center mb-4">
        <h3 id="qrScannerTitle" class="text-lg font-bold text-slate-800"></h3>
        <button id="closeScannerBtn" class="text-slate-500 hover:text-slate-800"><i class="fas fa-times text-2xl"></i></button>
      </div>
      <div id="qr-reader" class="rounded-lg overflow-hidden w-full bg-slate-900"></div>
    </div>
  </div>

  <div id="fileReceiveModal" class="modal">
    <div class="modal-content glassmorphic rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 border-0">
      <div class="text-center mb-6">
        <div class="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ring-8 ring-indigo-50">
          <i class="fas fa-file-download text-3xl text-indigo-600"></i>
        </div>
        <h3 class="text-xl font-bold text-slate-800 mb-2">Incoming File</h3>
        <p id="fileReceiveSubtext" class="text-sm text-slate-600"></p>
      </div>
      <div class="bg-slate-50/50 rounded-lg p-4 mb-6 flex items-center gap-3">
        <i id="fileReceiveIcon" class="fas fa-file text-3xl text-indigo-600"></i>
        <div class="flex-1 min-w-0">
          <p id="fileReceiveName" class="font-bold text-slate-800 truncate"></p>
          <p id="fileReceiveSize" class="text-sm text-slate-500"></p>
          <p id="fileReceiveFrom" class="text-xs text-slate-400 mt-1"></p>
        </div>
      </div>
      <div class="flex gap-3">
        <button id="declineBtn" class="btn flex-1 bg-slate-200 text-slate-700 px-4 py-3 rounded-lg"><i class="fas fa-times mr-2"></i>Decline</button>
        <button id="acceptBtn" class="btn btn-primary flex-1 px-4 py-3 rounded-lg"><i class="fas fa-check mr-2"></i>Accept</button>
      </div>
    </div>
  </div>

  <script>
  "use strict";

  // ---------- Elements ----------
  const $ = (id) => document.getElementById(id);

  // ---------- UI Navigation ----------
  function navigateTo(screenId) {
      document.querySelectorAll('.app-screen').forEach(screen => screen.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

      const targetScreen = $(screenId);
      if (targetScreen) {
          targetScreen.classList.add('active');
          const navBtn = screenId === 'homeScreen' ? $('navHomeBtn') : $('navTransferBtn');
          if (navBtn) navBtn.classList.add('active');
      }
  }

  // ---------- Notifications ----------
  function notify(message, type = "info") {
    const colors = {
      success: "bg-green-100 text-green-700 border-green-500",
      error: "bg-red-100 text-red-700 border-red-500",
      warning: "bg-yellow-100 text-yellow-700 border-yellow-500",
      info: "bg-indigo-100 text-indigo-700 border-indigo-500"
    };
    const icons = {
      success: "fa-check-circle",
      error: "fa-exclamation-circle",
      warning: "fa-info-circle",
      info: "fa-info-circle"
    };
    const n = document.createElement("div");
    n.className = `fixed top-4 right-4 border-l-4 p-4 rounded-lg shadow-lg z-50 max-w-sm ${colors[type]} transition-all duration-300 transform translate-x-full opacity-0`;
    n.innerHTML = `<div class="flex items-center">
      <i class="fas ${icons[type]} text-xl mr-3"></i>
      <p class="text-sm font-medium">${message}</p>
    </div>`;
    document.body.appendChild(n);
    requestAnimationFrame(() => {
        n.classList.remove('translate-x-full', 'opacity-0');
    });
    setTimeout(() => {
        n.classList.add('translate-x-full', 'opacity-0');
        n.addEventListener('transitionend', () => n.remove());
    }, 3000);
  }

  // ---------- Utils ----------
  function formatBytes(b) {
    if (!b) return "0 Bytes";
    const k = 1024, sizes = ["Bytes","KB","MB","GB","TB"];
    const i = Math.floor(Math.log(b)/Math.log(k));
    return `${parseFloat((b/Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
  }

  let audioContext = null;
  window.addEventListener("click", () => {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
  }, { once: true });

  function beep(kind = "info") {
    if (!audioContext) return;
    const o = audioContext.createOscillator();
    const g = audioContext.createGain();
    o.connect(g); g.connect(audioContext.destination);
    o.type = "sine";
    o.frequency.value = kind === "error" ? 220 : (kind === "complete" ? 880 : 440);
    g.gain.setValueAtTime(0.25, audioContext.currentTime);
    g.gain.exponentialRampToValueAtTime(1e-4, audioContext.currentTime + 0.25);
    o.start(); o.stop(audioContext.currentTime + 0.25);
  }

  // ---------- State ----------
  let peer = null;
  let myPeerId = null;
  let preferredPeerId = null;
  let peerReadyResolve = null;
  let isPeerReady = false;
  const peerReady = new Promise((res) => { peerReadyResolve = res; });
  let myDeviceName = null;
  let connectionMode = null;
  let roomCode = null;
  let isHost = false;
  const connections = {};
  const pendingReceives = new Map();
  const sendQueue = [];
  let currentSend = null;
  const CHUNK_SIZE = 4 * 1024 * 1024;
  const WINDOW_SIZE = 16;
  const sendStates = new Map();
  const groupSendTracker = new Map();
  let html5QrCode = null;
  let qrScannerMode = null;
  let qrScanLocked = false;

  // ---------- Peer config ----------
  const peerConfig = {
    config: {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "stun:global.stun.twilio.com:3478" }
      ]
    }
  };

  // ---------- Init ----------
  window.addEventListener("load", initialize);

  function initialize() {
    loadDeviceName();
    bindUI();
    preferredPeerId = genId();
    $("myPeerId").textContent = preferredPeerId;
    setupPeer(preferredPeerId);
  }

  function genId() {
    return "EZ-" + Math.random().toString(36).slice(2, 8).toUpperCase();
  }

  function loadDeviceName() {
    const saved = localStorage.getItem("deviceName");
    myDeviceName = saved || `Device-${Math.random().toString(36).slice(2,6).toUpperCase()}`;
    $("deviceNameInput").value = myDeviceName;
  }

  function bindUI() {
    // Nav
    $('navHomeBtn').addEventListener('click', () => navigateTo('homeScreen'));
    $('navTransferBtn').addEventListener('click', () => {
        if (!Object.keys(connections).length) {
            notify("You must be connected to a peer or room first.", "warning");
            return;
        }
        navigateTo('transferWindow');
    });

    // Home Screen
    $("saveNameBtn").addEventListener("click", () => {
      const name = $("deviceNameInput").value.trim();
      if (name) {
        myDeviceName = name;
        localStorage.setItem("deviceName", name);
        notify("Device name saved!", "success");
      }
    });
    $("copyMyIdBtn").addEventListener("click", async () => {
      const id = myPeerId || preferredPeerId;
      if (id) {
        await navigator.clipboard.writeText(id);
        notify("Direct ID copied!", "success");
      }
    });
    $("showMyIdQrBtn").addEventListener("click", () => showMyIdQr());
    $("connectDirectBtn").addEventListener("click", connectDirect);
    $("scanDirectBtn").addEventListener("click", () => openQRScanner("direct"));
    $("createRoomBtn").addEventListener("click", createRoom);
    $("joinRoomBtn").addEventListener("click", joinRoom);
    $("scanRoomBtn").addEventListener("click", () => openQRScanner("room"));

    // Modals
    $("closeQrBtn").addEventListener("click", closeQR);
    $("closeScannerBtn").addEventListener("click", closeQRScanner);

    // Transfer Screen
    $("sendChatBtn").addEventListener("click", sendChatMessage);
    $("chatInput").addEventListener("keypress", (e) => { if (e.key === "Enter") sendChatMessage(); });
    const dropZone = $("dropZone");
    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.add("border-indigo-500", "bg-indigo-50");
    });
    dropZone.addEventListener("dragleave", (e) => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.remove("border-indigo-500", "bg-indigo-50");
    });
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.remove("border-indigo-500", "bg-indigo-50");
      if (e.dataTransfer.files && e.dataTransfer.files.length) {
        queueFilesForTransfer(e.dataTransfer.files);
      }
    });
    $("fileInput").addEventListener("change", (e) => {
      if (e.target.files && e.target.files.length) {
        queueFilesForTransfer(e.target.files);
      }
      e.target.value = "";
    });
  }

  // ---------- Peer setup ----------
  function setupPeer(customId) {
    try { if (peer) peer.destroy(); } catch (_) {}
    peer = customId ? new Peer(customId, peerConfig) : new Peer(peerConfig);
    peer.on("open", (id) => {
      myPeerId = id;
      isPeerReady = true;
      if (peerReadyResolve) peerReadyResolve(true);
      $("myPeerId").textContent = id;
      updateStatus("Online", "green");
    });
    peer.on("connection", (conn) => {
      if (!connectionMode) {
        connectionMode = (isHost || (roomCode && roomCode === myPeerId)) ? "room" : "direct";
      }
      handleConnection(conn);
    });
    peer.on("error", (err) => {
      console.error("Peer error:", err);
      if (String(err?.type || err).includes("unavailable-id")) {
        preferredPeerId = genId();
        $("myPeerId").textContent = preferredPeerId;
        setupPeer(preferredPeerId);
        return;
      }
      const msg = connectionMode === "room"
        ? (isHost ? "Room host error." : "Room not found or unreachable.")
        : "A connection error occurred.";
      notify(msg, "error");
      updateStatus("Error", "red");
    });
    peer.on("disconnected", () => {
      updateStatus("Reconnecting...", "orange");
    });
  }

  function awaitPeerReady(fn) {
    if (isPeerReady) { fn(); return; }
    peerReady.then(() => fn());
  }

  function updateStatus(text, color) {
    const iconColor = { green: 'green-500', red: 'red-500', orange: 'orange-500', gray: 'gray-400'};
    $("connectionStatus").innerHTML =
      `<i class="fas fa-circle text-${iconColor[color] || iconColor.gray} mr-1 animate-pulse"></i>${text}`;
  }

  // ---------- Connections ----------
  function connectDirect() {
    connectionMode = "direct";
    isHost = false;
    const remoteId = $("remotePeerIdInput").value.trim();
    if (remoteId && !remoteId.startsWith("EZ-")) {
        notify("Invalid Direct ID format.", "error");
        return;
    }
    if (!remoteId) { notify("Please enter a Direct ID.", "warning"); return; }
    if (remoteId === (myPeerId || preferredPeerId)) {
      notify("Cannot connect to yourself.", "error"); return;
    }
    awaitPeerReady(() => {
      const conn = peer.connect(remoteId, { reliable: true, metadata: { deviceName: myDeviceName } });
      handleConnection(conn);
    });
  }

  function createRoom() {
    connectionMode = "room";
    isHost = true;
    roomCode = Math.random().toString(36).toUpperCase().slice(2, 8);
    setupPeer(roomCode);
    showTransferWindow();
  }

  let isJoiningRoom = false;
  function joinRoom() {
    if (isJoiningRoom) return;
    const code = $("roomCodeInput").value.trim().toUpperCase();
    if (code && code.startsWith("EZ-")) {
        notify("Invalid Room Code format.", "error");
        return;
    }
    if (!code) { notify("Please enter a room code.", "warning"); return; }
    connectionMode = "room";
    isHost = false;
    roomCode = code;
    isJoiningRoom = true;
    awaitPeerReady(() => {
      const conn = peer.connect(roomCode, { reliable: true, metadata: { deviceName: myDeviceName } });
      handleConnection(conn);
      setTimeout(() => { isJoiningRoom = false; }, 500);
    });
  }

  function leaveRoom() {
    if (connectionMode !== "room") { location.reload(); return; }
    broadcast({ type: "room-closed" });
    Object.values(connections).forEach(c => { try { c.close(); } catch(_) {} });
    setTimeout(() => location.reload(), 300);
  }

  function handleConnection(conn) {
    conn.on("open", () => {
      connections[conn.peer] = conn;
      conn.send({ type: "metadata-sync", deviceName: myDeviceName, mode: connectionMode, roomCode });
      closeQRScanner();
      showTransferWindow();
      updatePeerListUI();
    });
    conn.on("data", (data) => { routeData(data, conn); });
    conn.on("close", () => {
      delete connections[conn.peer];
      if (connectionMode === "direct") {
        notify("Peer disconnected.", "info");
        setTimeout(() => location.reload(), 1000);
      } else {
        updatePeerListUI();
      }
    });
    conn.on("error", (err) => {
      console.error("Connection error:", conn.peer, err);
      notify("A connection encountered an error.", "error");
    });
  }

  function broadcast(payload, excludePeerId = null) {
    Object.keys(connections).forEach((id) => {
      if (id === excludePeerId) return;
      const c = connections[id];
      if (c && c.open) c.send(payload);
    });
  }

  function routeData(data, conn) {
    if (!data || typeof data !== "object" || typeof data.type !== "string") return;
    switch (data.type) {
      case "metadata-sync":
        if (connections[conn.peer]) {
          connections[conn.peer].metadata = { deviceName: data.deviceName };
        }
        if (!connectionMode && data.mode) {
          connectionMode = data.mode;
          roomCode = data.roomCode || roomCode;
        }
        updatePeerListUI();
        showTransferWindow();
        break;
      case "room-closed":
        notify("Room closed by host.", "warning");
        setTimeout(() => location.reload(), 1000);
        break;
      case "chat-message": displayChatMessage(data); beep("info"); break;
      case "file-request": onFileRequest(data, conn); break;
      case "file-accepted": onFileAccepted(data, conn); break;
      case "file-rejected": onFileRejected(data, conn); break;
      case "file-chunk": onFileChunk(data, conn); break;
      case "file-ack": onAck(data, conn); break;
      case "file-cancel": onFileCancel(data, conn); break;
    }
  }

  // ---------- UI Updates ----------
  function showTransferWindow() {
    if (!isHost) closeQR();
    navigateTo('transferWindow');
    const header = $("transferHeader");
    const peerListContainer = $("peerListContainer");
    if (connectionMode === "direct") {
      const remote = Object.values(connections)[0];
      const peerName = remote?.metadata?.deviceName || "Peer";
      header.innerHTML = `<div class="flex flex-col md:flex-row items-center justify-between gap-4">
          <div class="flex items-center gap-4"><div class="bg-white/20 text-white w-16 h-16 rounded-full flex items-center justify-center text-3xl"><i class="fas fa-user"></i></div>
          <div><h2 class="text-2xl font-bold">Connected to ${peerName}</h2><p class="text-sm opacity-80 font-mono">${remote?.peer || ""}</p></div></div>
          <div><button class="btn bg-red-500 text-white px-5 py-2.5 rounded-lg hover:bg-red-600" onclick="location.reload()"><i class="fas fa-times mr-2"></i>Disconnect</button></div></div>`;
      peerListContainer.classList.add("hidden");
      $("sendFileTitle").innerHTML = `<i class="fas fa-paper-plane text-purple-600 mr-2"></i>Send Files`;
      $("chatTitle").innerHTML = `<i class="fas fa-comments text-green-600 mr-2"></i>Direct Chat`;
    } else {
      header.innerHTML = `<div class="flex flex-col md:flex-row items-center justify-between gap-4">
          <div class="flex items-center gap-4"><div class="bg-white/20 text-white w-16 h-16 rounded-full flex items-center justify-center text-3xl"><i class="fas fa-users"></i></div>
          <div><h2 class="text-2xl font-bold">Room Code <span class="font-mono bg-black/20 px-2 py-1 rounded">${roomCode || ""}</span></h2><p class="text-sm opacity-90">Your Name: ${myDeviceName}</p></div></div>
          <div class="flex gap-2">
            <button class="btn bg-white/20 text-white px-4 py-2 rounded-lg" onclick="navigator.clipboard.writeText('${roomCode || ""}').then(()=>notify('Room code copied!','success'))"><i class="fas fa-copy mr-2"></i>Copy</button>
            <button class="btn bg-white/20 text-white px-4 py-2 rounded-lg" onclick="showRoomQr()"><i class="fas fa-qrcode mr-2"></i>QR</button>
            <button class="btn bg-red-500 text-white px-5 py-2.5 rounded-lg hover:bg-red-600" onclick="leaveRoom()"><i class="fas fa-door-open mr-2"></i>Leave</button>
          </div></div>`;
      peerListContainer.classList.remove("hidden");
      $("sendFileTitle").innerHTML = `<i class="fas fa-paper-plane text-indigo-600 mr-2"></i>Send Files to Room`;
      $("chatTitle").innerHTML = `<i class="fas fa-comments text-green-600 mr-2"></i>Room Chat`;
      updatePeerListUI();
    }
  }

  function updatePeerListUI() {
    if (connectionMode !== "room") return;
    const container = $("peerList");
    let html = `<div class="p-2 bg-indigo-50 rounded-lg text-sm font-bold text-indigo-700">${myDeviceName} ${isHost ? "(Host)" : ""}</div>`;
    Object.values(connections).forEach((c) => {
      if (!c || c.peer === myPeerId) return;
      const name = c.metadata?.deviceName || c.peer;
      html += `<div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg text-sm text-slate-700"><span>${name}</span></div>`;
    });
    if (!Object.values(connections).filter(c => !!c).length) {
      html += `<p class="text-xs text-slate-400 text-center py-2">You are alone in this room.</p>`;
    }
    container.innerHTML = html;
  }

  // ---------- File Transfer Logic ----------
  function queueFilesForTransfer(fileList) {
    const files = Array.from(fileList);
    if (!files.length || !Object.keys(connections).length) {
      notify("No one is connected!", "warning"); return;
    }
    for (const file of files) {
      const baseId = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
      sendQueue.push({ baseId, file });
      addQueueUI(`pending-${baseId}`, `${file.name}`, true, "Waiting...");
    }
    if (!currentSend) processSendQueue();
  }

  function processSendQueue() {
    if (currentSend || sendQueue.length === 0) return;
    const next = sendQueue.shift();
    const { baseId, file } = next;
    currentSend = { baseId, file };
    removeQueueItemInstant(`pending-${baseId}`);
    const recipients = connectionMode === "direct" ? [Object.values(connections)[0]].filter(Boolean) : Object.values(connections);
    groupSendTracker.set(baseId, { targets: new Set(recipients.map(c => c.peer)), accepted: new Set(), rejected: new Set(), completed: new Set() });
    for (const c of recipients) {
      const peerName = c.metadata?.deviceName || c.peer;
      const transferKey = getTransferKey(baseId, c.peer);
      addQueueUI(transferKey, `${file.name} → ${peerName}`, true, "Offering...");
      c.send({ type: "file-request", id: baseId, name: file.name, size: file.size, fileType: file.type, senderId: myPeerId || preferredPeerId, senderName: myDeviceName });
    }
  }

  function getTransferKey(baseId, peerId) { return `${baseId}|${peerId}`; }

  function onFileAccepted(data, conn) {
    if (!currentSend || currentSend.baseId !== data.id) return;
    const tracker = groupSendTracker.get(data.id);
    if (tracker) tracker.accepted.add(conn.peer);
    const { file } = currentSend;
    const transferKey = getTransferKey(data.id, conn.peer);
    const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
    sendStates.set(transferKey, { baseId: data.id, peerId: conn.peer, file, conn, start: Date.now(), nextIndex: 0, totalChunks, inFlight: 0, ackedCount: 0, ackedBytes: 0 });
    pumpChunks(transferKey);
  }

  function onFileRejected(data, conn) {
    if (!currentSend || currentSend.baseId !== data.id) return;
    const tracker = groupSendTracker.get(data.id);
    if (tracker) {
      tracker.rejected.add(conn.peer);
      tracker.accepted.delete(conn.peer);
    }
    updateProgressUI(getTransferKey(data.id, conn.peer), undefined, undefined, "Declined");
    if (connectionMode === "direct") {
      notify("Transfer rejected.", "warning");
    } else if (tracker && tracker.rejected.size === tracker.targets.size && tracker.accepted.size === 0) {
      for (const peerId of tracker.targets) removeQueueItemInstant(getTransferKey(data.id, peerId));
      notify("All peers rejected the file.", "warning");
    }
    finishBaseIfDone(data.id);
  }

  function onAck(data, conn) {
    const key = getTransferKey(data.transferId, conn.peer);
    const state = sendStates.get(key);
    if (!state) return;
    state.inFlight = Math.max(0, state.inFlight - 1);
    state.ackedCount++;
    const isLast = (data.chunkIndex === state.totalChunks - 1);
    const sizeAck = isLast ? (state.file.size - CHUNK_SIZE * (state.totalChunks - 1)) : CHUNK_SIZE;
    state.ackedBytes += sizeAck;
    const progress = (state.ackedBytes / state.file.size) * 100;
    const speed = senderSpeedMBps(state);
    const status = connectionMode === "direct" ? "Sending..." : `Sending to ${state.conn.metadata?.deviceName || state.peerId}`;
    updateProgressUI(key, progress, speed, status);
    if (state.ackedCount >= state.totalChunks) {
      updateProgressUI(key, 100, speed, "Sent!");
      addHistory(`Sent ${state.file.name} (${formatBytes(state.file.size)})`, "send");
      beep("complete");
      const tracker = groupSendTracker.get(state.baseId);
      if (tracker) {
        tracker.completed.add(conn.peer);
        tracker.accepted.delete(conn.peer);
      }
      sendStates.delete(key);
      finishBaseIfDone(state.baseId);
      return;
    }
    pumpChunks(key);
  }

  async function pumpChunks(transferKey) {
    const state = sendStates.get(transferKey);
    if (!state) return;
    const { file, conn } = state;
    while (state.inFlight < WINDOW_SIZE && state.nextIndex < state.totalChunks) {
      const start = state.nextIndex * CHUNK_SIZE;
      const end = Math.min(start + CHUNK_SIZE, file.size);
      const arrayBuffer = await file.slice(start, end).arrayBuffer();
      conn.send({ type: "file-chunk", payload: arrayBuffer, transferId: state.baseId, chunkIndex: state.nextIndex, totalChunks: state.totalChunks, name: file.name, fileType: file.type, size: file.size, senderName: myDeviceName });
      state.nextIndex++;
      state.inFlight++;
    }
  }

  function senderSpeedMBps(state) {
    const elapsed = Math.max(0.001, (Date.now() - state.start) / 1000);
    return (state.ackedBytes / 1024 / 1024) / elapsed;
  }

  function finishBaseIfDone(baseId) {
    const tracker = groupSendTracker.get(baseId);
    if (!tracker) {
      if (currentSend && currentSend.baseId === baseId) {
          currentSend = null;
          processSendQueue();
      }
      return;
    }
    const activeForBase = Array.from(sendStates.keys()).some(k => k.startsWith(`${baseId}|`));
    const decidedCount = tracker.completed.size + tracker.rejected.size;
    if (decidedCount >= tracker.targets.size && !activeForBase) {
      currentSend = (currentSend && currentSend.baseId === baseId) ? null : currentSend;
      groupSendTracker.delete(baseId);
      processSendQueue();
    }
  }

  function cancelTransfer(transferKey) {
    const [baseId, peerId] = transferKey.split("|");
    const conn = connections[peerId];
    if (conn && conn.open) { conn.send({ type: "file-cancel", id: baseId }); }
    if (sendStates.has(transferKey)) { sendStates.delete(transferKey); }
    updateProgressUI(transferKey, undefined, undefined, "Cancelled");
    const tracker = groupSendTracker.get(baseId);
    if (tracker) {
      tracker.rejected.add(peerId);
      tracker.accepted.delete(peerId);
      if (connectionMode === "direct") {
        for (const target of tracker.targets) removeQueueItemInstant(getTransferKey(baseId, target));
        groupSendTracker.delete(baseId);
        if (currentSend && currentSend.baseId === baseId) currentSend = null;
        processSendQueue();
        return;
      }
      finishBaseIfDone(baseId);
    } else {
      if (currentSend && currentSend.baseId === baseId) currentSend = null;
      processSendQueue();
    }
  }

  function onFileRequest(meta, conn) {
    if (meta.senderId === (myPeerId || preferredPeerId)) return;
    const iconMap = { "jpg": "fa-file-image", "jpeg": "fa-file-image", "png": "fa-file-image", "pdf": "fa-file-pdf", "zip": "fa-file-zipper", "mp4": "fa-file-video", "mp3": "fa-file-audio" };
    const ext = (meta.name.split(".").pop() || "").toLowerCase();
    $("fileReceiveSubtext").textContent = connectionMode === "direct" ? "A peer wants to send you a file" : "A peer in the room wants to send a file";
    $("fileReceiveName").textContent = meta.name;
    $("fileReceiveSize").textContent = formatBytes(meta.size);
    $("fileReceiveFrom").textContent = `From ${meta.senderName || conn.peer}`;
    $("fileReceiveIcon").className = `fas ${iconMap[ext] || "fa-file"} text-3xl text-indigo-600`;
    $("fileReceiveModal").dataset.transferId = meta.id;
    $("fileReceiveModal").dataset.fromPeer = conn.peer;
    $("fileReceiveModal").classList.add("show");
    pendingReceives.set(meta.id, { meta, conn, chunks: [], receivedSize: 0, start: Date.now() });
  }

  $("acceptBtn").addEventListener("click", () => {
    const transferId = $("fileReceiveModal").dataset.transferId;
    const p = pendingReceives.get(transferId);
    if (!p) return;
    p.conn.send({ type: "file-accepted", id: transferId, name: p.meta.name });
    addQueueUI(transferId, p.meta.name, false, "Receiving...");
    $("fileReceiveModal").classList.remove("show");
  });

  $("declineBtn").addEventListener("click", () => {
    const transferId = $("fileReceiveModal").dataset.transferId;
    const p = pendingReceives.get(transferId);
    if (!p) return;
    p.conn.send({ type: "file-rejected", id: transferId, name: p.meta.name });
    pendingReceives.delete(transferId);
    addHistory(`Declined ${p.meta.name}`, "decline");
    $("fileReceiveModal").classList.remove("show");
  });

  function onFileChunk(data, conn) {
    const { payload, transferId, chunkIndex, totalChunks, fileType, name, size } = data;
    const p = pendingReceives.get(transferId);
    if (!p) return;
    p.chunks[chunkIndex] = payload;
    p.receivedSize += (payload?.byteLength || 0);
    const progress = (p.receivedSize / size) * 100;
    const elapsed = (Date.now() - p.start) / 1000;
    const speedMBps = elapsed > 0 ? (p.receivedSize / 1024 / 1024) / elapsed : 0;
    updateProgressUI(transferId, progress, speedMBps, "Receiving...");
    conn.send({ type: "file-ack", transferId, chunkIndex });
    if (p.chunks.filter(Boolean).length === totalChunks) {
      try {
        const ordered = Array.from({length: totalChunks}).map((_, i) => new Uint8Array(p.chunks[i]));
        const blob = new Blob(ordered, { type: fileType || "application/octet-stream" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = name || "download";
        a.click();
        URL.revokeObjectURL(a.href);
        updateProgressUI(transferId, undefined, undefined, "Completed!");
        addHistory(`Received ${name} (${formatBytes(size)})`, "receive");
        beep("complete");
      } catch (e) {
        console.error("Complete receive error:", e);
        updateProgressUI(transferId, undefined, undefined, "Error!");
        beep("error");
      } finally {
        pendingReceives.delete(transferId);
      }
    }
  }

  function onFileCancel(data, conn) {
    const id = data.id;
    if (pendingReceives.has(id)) {
      if ($("fileReceiveModal").dataset.transferId === id) {
        $("fileReceiveModal").classList.remove("show");
      }
      pendingReceives.delete(id);
    }
    notify("Sender cancelled the transfer.", "warning");
    updateProgressUI(id, undefined, undefined, "Cancelled");
  }

  // ---------- Queue UI & History & Chat ----------
  function addQueueUI(id, fileName, isSender, initialStatus = null) {
    const q = $("fileQueue");
    if (q.querySelector("p")) q.innerHTML = "";
    const el = document.createElement("div");
    el.id = `transfer-${id}`;
    el.className = "queue-item";
    el.innerHTML = `<div class="bg-slate-100 rounded-lg p-3 mb-2">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium text-slate-800 break-all" title="${fileName}">${fileName}</span>
        <div class="flex items-center gap-3">
          <span class="text-sm font-medium text-indigo-600" id="percent-${id}">0%</span>
          ${isSender ? `<button id="cancel-${id}" class="cancel-btn text-red-500 hover:text-red-600" title="Cancel"><i class="fas fa-times-circle"></i></button>` : ``}
        </div>
      </div>
      <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden progress-bar-bg"><div id="bar-${id}" class="progress-bar h-2 rounded-full" style="width:0%"></div></div>
      <div class="flex justify-between text-xs text-slate-500 mt-1"><span id="speed-${id}">0.00 MB/s</span><span id="status-${id}">${initialStatus ?? "Waiting..."}</span></div>
      </div>`;
    q.appendChild(el);
    if (isSender) {
      const btn = $(`cancel-${id}`);
      if (btn) {
        if (id.startsWith("pending-")) {
          btn.addEventListener("click", () => cancelPending(id.slice("pending-".length)));
        } else {
          btn.addEventListener("click", () => cancelTransfer(id));
        }
      }
    }
  }

  function updateProgressUI(id, progress, speedMBps, status) {
    const root = $(`transfer-${id}`);
    if (!root) return;
    if (typeof progress === "number") {
      $(`percent-${id}`).textContent = `${Math.round(progress)}%`;
      $(`bar-${id}`).style.width = `${progress}%`;
    }
    if (typeof speedMBps === "number") $(`speed-${id}`).textContent = `${speedMBps.toFixed(2)} MB/s`;
    if (typeof status === "string") $(`status-${id}`).textContent = status;
    if (["Completed!", "Declined", "Error!", "Sent!", "Cancelled"].includes(status)) {
      setTimeout(() => {
        root.remove();
        if (!document.querySelector("[id^='transfer-']")) {
          $("fileQueue").innerHTML = `<p class="text-sm text-slate-400 text-center py-4">No active transfers</p>`;
        }
      }, 2000);
    }
  }

  function removeQueueItemInstant(id) {
    const root = $(`transfer-${id}`);
    if (root) root.remove();
    if (!$("fileQueue").children.length) {
        $("fileQueue").innerHTML = `<p class="text-sm text-slate-400 text-center py-4">No active transfers</p>`;
    }
  }

  function displayChatMessage(data, isSent = false) {
    const box = $("chatMessages");
    const wrapper = document.createElement("div");
    wrapper.className = `flex flex-col ${isSent ? "items-end" : "items-start"}`;
    if (connectionMode === "room" && !isSent) {
      const name = document.createElement("span");
      name.className = "text-xs text-slate-500 mb-1 px-2";
      name.textContent = data.senderName || "Peer";
      wrapper.appendChild(name);
    }
    const bubble = document.createElement("div");
    bubble.className = `p-3 rounded-2xl max-w-xs break-words ${isSent ? "chat-bubble-sent" : "chat-bubble-received"}`;
    bubble.textContent = data.content || "";
    wrapper.appendChild(bubble);
    box.appendChild(wrapper);
    box.scrollTop = box.scrollHeight;
    if (!isSent) beep("info");
  }
  
  function sendChatMessage() {
    const input = $("chatInput");
    const message = input.value.trim();
    if (!message) return;
    const payload = { type: "chat-message", content: message, senderName: myDeviceName };
    broadcast(payload);
    displayChatMessage({ content: message }, true);
    input.value = "";
  }
  
  function addHistory(message, type = "info") {
    if (!["send", "receive", "decline"].includes(type)) return;
    const h = $("sessionHistory");
    if (h.querySelector("p")) h.innerHTML = "";
    const icons = { send: "fa-arrow-up text-indigo-600", receive: "fa-arrow-down text-green-600", decline: "fa-times-circle text-red-500" };
    const div = document.createElement("div");
    div.className = "flex items-center gap-3 p-2 bg-slate-50 rounded-lg";
    div.innerHTML = `<i class="fas ${icons[type]} w-5 text-center"></i><div class="flex-1 min-w-0"><p class="text-sm text-slate-800 truncate">${message}</p><p class="text-xs text-slate-500">${new Date().toLocaleTimeString()}</p></div>`;
    h.insertBefore(div, h.firstChild);
  }

  // ---------- QR Modals ----------
  function showMyIdQr() {
    $("qrModalTitle").textContent = "Your Direct ID";
    const container = $("qrcodeContainer");
    container.innerHTML = "";
    new QRCode(container, { text: (myPeerId || preferredPeerId) || "", width: 256, height: 256, colorDark: "#1e293b", colorLight: "#ffffff" });
    $("qrCodeText").textContent = (myPeerId || preferredPeerId) || "";
    $("qrModal").classList.add("show");
  }

  function showRoomQr() {
    $("qrModalTitle").textContent = "Room Code";
    const container = $("qrcodeContainer");
    container.innerHTML = "";
    new QRCode(container, { text: roomCode || "", width: 256, height: 256, colorDark: "#1e293b", colorLight: "#ffffff" });
    $("qrCodeText").textContent = roomCode || "";
    $("qrModal").classList.add("show");
  }

  function closeQR() {
    $("qrModal").classList.remove("show");
  }

  function openQRScanner(mode) {
    if (html5QrCode && html5QrCode.isScanning) return;
    qrScannerMode = mode;
    qrScanLocked = false;
    $("qrScannerTitle").textContent = `Scan ${mode === "direct" ? "Peer" : "Room"} QR Code`;
    $("qrScannerModal").classList.add("show");
    html5QrCode = new Html5Qrcode("qr-reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 250, height: 250 } },
      (decodedText) => {
        if (qrScanLocked) return;
        qrScanLocked = true;
        beep("complete");
        if (qrScannerMode === "direct") {
            if (!decodedText.startsWith("EZ-")) {
                notify("Invalid QR Code for Direct Connection.", "error");
                setTimeout(() => qrScanLocked = false, 1500);
                return;
            }
            $("remotePeerIdInput").value = decodedText;
            closeQRScanner().then(connectDirect);
        } else {
            if (decodedText.startsWith("EZ-")) {
                notify("Invalid QR Code for Room Connection.", "error");
                setTimeout(() => qrScanLocked = false, 1500);
                return;
            }
            $("roomCodeInput").value = decodedText;
            joinRoom();
            setTimeout(() => qrScanLocked = false, 1500);
        }
      },
      (errMsg) => {}
    ).catch((err) => {
      console.error("QR start error:", err);
      notify("Could not start camera.", "error");
      closeQRScanner();
    });
  }

  function closeQRScanner() {
    return new Promise((resolve) => {
        const modal = $("qrScannerModal");
        if (!modal.classList.contains("show") || !html5QrCode) {
            resolve();
            return;
        }
        html5QrCode.stop()
            .then(() => {
                html5QrCode.clear();
                html5QrCode = null;
                modal.classList.remove("show");
                resolve();
            })
            .catch(err => {
                console.error("QR stop error:", err);
                html5QrCode = null;
                modal.classList.remove("show");
                resolve();
            });
    });
  }
  </script>
</body>
</html>

