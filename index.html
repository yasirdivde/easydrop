<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyDrop P2P - WebRTC File Sharing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .device-card { transition: all 0.3s ease; cursor: pointer; }
        .device-card:hover { transform: scale(1.05); }
        .online { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .hidden { display: none !important; }
        .chat-bubble-sent { background-color: #3b82f6; color: white; align-self: flex-end; }
        .chat-bubble-received { background-color: #e5e7eb; color: #1f2937; align-self: flex-start; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">

    <!-- Main Home Screen -->
    <div id="homeScreen" class="container mx-auto px-4 py-4 md:py-8 max-w-6xl">
        
        <!-- Header -->
        <div class="text-center mb-6 md:mb-8">
            <div class="flex items-center justify-center mb-4">
                <i class="fas fa-paper-plane text-4xl md:text-5xl text-blue-600"></i>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">EasyDrop P2P</h1>
            <p class="text-sm md:text-base text-slate-600 mb-4 px-4">Direct peer-to-peer file sharing • No file size limits</p>
            
            <!-- Device Name -->
            <div class="bg-white rounded-lg p-3 md:p-4 inline-block shadow-lg mb-4 max-w-full mx-4">
                <p class="text-xs md:text-sm text-slate-600 mb-2">Your Device Name:</p>
                <div class="flex items-center gap-2 flex-wrap justify-center">
                    <input type="text" id="deviceNameInput" class="text-base md:text-lg font-bold text-blue-600 bg-slate-100 px-3 md:px-4 py-2 rounded border-2 border-transparent focus:border-blue-500 outline-none max-w-xs" value="My Device">
                    <button onclick="saveDeviceName()" class="bg-green-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-green-700" title="Save Name">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
            </div>
            <!-- Connection Status -->
            <div class="mt-4">
                <span id="connectionStatus" class="text-xs md:text-sm text-slate-500">
                    <i class="fas fa-circle text-gray-400 mr-1"></i>Waiting...
                </span>
            </div>
        </div>

        <!-- Connection Mode Selection -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Direct P2P Connection -->
            <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6">
                <h3 class="text-lg md:text-xl font-bold text-slate-800 mb-4">
                    <i class="fas fa-user text-purple-600 mr-2"></i>Direct P2P Connection
                </h3>
                <div class="bg-slate-50 rounded-lg p-3 mb-4">
                    <p class="text-xs text-slate-600 mb-1">Your Direct ID:</p>
                    <div class="flex items-center gap-2">
                        <code id="myPeerId" class="flex-1 text-sm font-mono font-bold text-purple-700 bg-slate-200 px-3 py-2 rounded break-all">Initializing...</code>
                        <button onclick="copyMyId()" class="text-purple-600 hover:text-purple-700" title="Copy ID"><i class="fas fa-copy"></i></button>
                        <button onclick="showMyIdQr()" class="text-purple-600 hover:text-purple-700" title="Show QR"><i class="fas fa-qrcode"></i></button>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <input type="text" id="remotePeerIdInput" placeholder="Enter Peer's Direct ID..." class="flex-1 border border-slate-300 rounded-lg px-4 py-3">
                    <div class="flex gap-2">
                         <button onclick="openQRScanner('direct')" class="flex-1 bg-teal-600 text-white px-4 py-3 rounded-lg hover:bg-teal-700"><i class="fas fa-camera mr-2"></i>Scan</button>
                         <button onclick="connectToPeer()" class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700"><i class="fas fa-link mr-2"></i>Connect</button>
                    </div>
                </div>
            </div>

            <!-- Room Connection -->
            <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6">
                 <h3 class="text-lg md:text-xl font-bold text-slate-800 mb-4">
                    <i class="fas fa-users text-blue-600 mr-2"></i>Rooms (Group)
                </h3>
                 <div class="flex flex-col gap-2">
                    <input type="text" id="roomCodeInput" placeholder="Enter Room Code..." class="flex-1 border border-slate-300 rounded-lg px-4 py-3">
                    <div class="flex gap-2">
                        <button onclick="openQRScanner('room')" class="flex-1 bg-teal-600 text-white px-4 py-3 rounded-lg hover:bg-teal-700"><i class="fas fa-camera mr-2"></i>Scan</button>
                        <button onclick="joinRoom()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700"><i class="fas fa-sign-in-alt mr-2"></i>Join</button>
                    </div>
                </div>
                <div class="text-center my-2 text-slate-500 text-sm">OR</div>
                <button onclick="createRoom()" class="w-full bg-blue-800 text-white px-6 py-3 rounded-lg hover:bg-blue-900">
                    <i class="fas fa-plus-circle mr-2"></i>Create New Room
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-xs md:text-sm text-slate-500 px-4">
            <p><i class="fas fa-shield-alt mr-1"></i>Peer-to-peer • End-to-end encrypted • No file size limits</p>
            <p class="mt-2"><i class="fas fa-server mr-1"></i>Files never stored on server • Direct device transfer</p>
        </div>
    </div>

    <!-- Transfer Window (Dynamically adapted) -->
    <div id="transferWindow" class="hidden container mx-auto px-4 py-4 md:py-8 max-w-7xl">
        
        <!-- Header -->
        <div id="transferHeader" class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl shadow-lg p-4 md:p-6 mb-6 text-white">
           <!-- Content generated by JS -->
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 flex flex-col gap-6">
                <!-- Send File Section -->
                <div class="bg-white rounded-2xl shadow-lg p-4 md:p-8">
                    <h3 id="sendFileTitle" class="text-xl md:text-2xl font-bold text-slate-800 mb-4 md:mb-6 text-center"></h3>
                    <div id="dropZone" class="border-3 border-dashed border-slate-300 rounded-xl p-8 md:p-12 text-center cursor-pointer hover:border-blue-400 transition-all">
                        <i class="fas fa-cloud-upload-alt text-5xl md:text-6xl text-slate-400 mb-4"></i>
                        <p class="text-lg md:text-xl text-slate-700 mb-2">Drag & Drop files here</p>
                        <p class="text-sm text-slate-500 mb-4">or</p>
                        <label for="fileInput" class="bg-blue-600 text-white px-6 py-3 rounded-lg cursor-pointer hover:bg-blue-700 transition-all inline-block"><i class="fas fa-folder-open mr-2"></i>Browse Files</label>
                        <input type="file" id="fileInput" class="hidden" multiple>
                    </div>
                </div>
                <!-- File Queue / Progress -->
                <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6">
                     <h3 class="text-lg md:text-xl font-bold text-slate-800 mb-4"><i class="fas fa-tasks text-blue-600 mr-2"></i>Transfer Queue</h3>
                    <div id="fileQueue" class="space-y-3"><p class="text-sm text-slate-400 text-center py-4">No active transfers</p></div>
                </div>
            </div>

            <!-- Right Column: Chat, Peers -->
            <div class="flex flex-col gap-6">
                 <!-- Connected Peers (Room mode only) -->
                <div id="peerListContainer" class="bg-white rounded-2xl shadow-lg p-4 md:p-6 hidden">
                    <h3 class="text-lg md:text-xl font-bold text-slate-800 mb-4"><i class="fas fa-user-friends text-purple-600 mr-2"></i>Connected Peers</h3>
                    <div id="peerList" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
                <!-- Chat -->
                <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6 flex flex-col h-[60vh] min-h-[400px]">
                    <h3 id="chatTitle" class="text-lg md:text-xl font-bold text-slate-800 mb-4"></h3>
                    <div id="chatMessages" class="flex-1 overflow-y-auto bg-slate-50 rounded-lg p-3 flex flex-col gap-2 mb-4"></div>
                    <div class="flex gap-2">
                        <input type="text" id="chatInput" class="flex-1 border border-slate-300 rounded-lg px-4 py-2" placeholder="Type a message...">
                        <button onclick="sendChatMessage()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Generic QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content bg-white rounded-2xl shadow-2xl p-4 md:p-6 max-w-sm w-full mx-4 text-center">
            <h3 id="qrModalTitle" class="text-lg md:text-xl font-bold text-slate-800 mb-4"></h3>
            <div id="qrcodeContainer" class="inline-block p-4 bg-white rounded-lg"></div>
            <p class="font-mono text-lg my-2" id="qrCodeText"></p>
            <button onclick="closeQR()" class="mt-4 bg-slate-200 text-slate-700 px-6 py-2 rounded-lg">Close</button>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="modal">
        <div class="modal-content bg-white rounded-2xl shadow-2xl p-4 md:p-6 max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="qrScannerTitle" class="text-lg md:text-xl font-bold text-slate-800"></h3>
                <button onclick="closeQRScanner()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="qr-reader" class="rounded-lg overflow-hidden w-full"></div>
        </div>
    </div>

    <!-- File Receive Confirmation Modal -->
    <div id="fileReceiveModal" class="modal">
        <div class="modal-content bg-white rounded-2xl shadow-2xl p-4 md:p-6 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-file-download text-3xl text-blue-600"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">Incoming File</h3>
                <p id="fileReceiveSubtext" class="text-sm md:text-base text-slate-600"></p>
            </div>
            <div class="bg-slate-50 rounded-lg p-4 mb-6">
                <div class="flex items-center gap-3">
                    <i id="fileReceiveIcon" class="fas fa-file text-3xl text-blue-600"></i>
                    <div class="flex-1 min-w-0">
                        <p id="fileReceiveName" class="font-bold text-slate-800 truncate"></p>
                        <p id="fileReceiveSize" class="text-sm text-slate-500"></p>
                        <p id="fileReceiveFrom" class="text-xs text-slate-400 mt-1"></p>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="declineFile()" class="flex-1 bg-slate-200 text-slate-700 px-4 py-3 rounded-lg"><i class="fas fa-times mr-2"></i>Decline</button>
                <button onclick="acceptFile()" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg"><i class="fas fa-check mr-2"></i>Accept</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let peer;
        let myPeerId;
        let myDeviceName;
        let connectionMode = null; // 'direct' or 'room'
        let roomCode = null;
        let connections = {}; // { peerId: conn }
        let isHost = false;
        let html5QrCode = null;
        let qrScannerMode = null;
        let audioContext;
        
        let fileSendQueue = [];
        let currentSendTransfer = null;
        let receiveFileTransfer = null;
        
        const peerConfig = {
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        };

        // --- INITIALIZATION ---
        function initialize() {
            loadDeviceName();
            setupPeer(); // Setup the default peer for direct connections
            window.addEventListener('click', () => {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }, { once: true });
        }

        function setupPeer(id = null) {
            if (peer) peer.destroy();
            
            peer = id ? new Peer(id, peerConfig) : new Peer(peerConfig);

            peer.on('open', (id) => {
                myPeerId = id;
                document.getElementById('myPeerId').textContent = id;
                updateConnectionStatus('Online', 'green');
                
                if (connectionMode === 'room') {
                    if (isHost) {
                        showTransferWindow();
                    } else {
                        const hostConnection = peer.connect(roomCode, { metadata: { deviceName: myDeviceName }, reliable: true });
                        handleConnection(hostConnection);
                    }
                }
            });

            peer.on('connection', (conn) => {
                // BUG FIX #1: If a connection is received while on the home screen,
                // it must be a direct connection. Set the mode accordingly.
                if (!connectionMode) {
                    connectionMode = 'direct';
                }
                handleConnection(conn);
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                if(err.type === 'peer-unavailable' && connectionMode === 'room') {
                    showNotification(`Room ${roomCode} not found.`, 'error');
                    resetToHome();
                } else if (err.type === 'peer-unavailable' && connectionMode === 'direct') {
                    showNotification(`Peer not found.`, 'error');
                }
                playSound('error');
            });
            peer.on('disconnected', () => { updateConnectionStatus('Reconnecting...', 'orange'); });
            peer.on('close', () => { console.log('Peer destroyed'); });
        }
        
        // --- CONNECTION MANAGEMENT ---
        function connectToPeer() {
            connectionMode = 'direct';
            const remoteId = document.getElementById('remotePeerIdInput').value.trim();
            if (!remoteId) return showNotification("Please enter a Peer's Direct ID", "error");
            if (remoteId === myPeerId) return showNotification("Cannot connect to yourself.", "error");
            const conn = peer.connect(remoteId, { metadata: { deviceName: myDeviceName }, reliable: true });
            handleConnection(conn);
        }
        
        function createRoom() {
            connectionMode = 'room';
            roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            isHost = true;
            setupPeer(roomCode);
        }

        function joinRoom() {
            connectionMode = 'room';
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!code) return showNotification('Please enter a room code.', 'error');
            roomCode = code;
            isHost = false;
            setupPeer();
        }
        
        function leave() {
            Object.values(connections).forEach(conn => conn.close());
            if (isHost && peer) peer.destroy(); // Dissolves the room
            resetToHome();
        }
        
        function resetToHome() {
            if (peer && !peer.destroyed && !isHost) peer.destroy();
            connections = {};
            isHost = false;
            roomCode = null;
            connectionMode = null;
            document.getElementById('homeScreen').classList.remove('hidden');
            document.getElementById('transferWindow').classList.add('hidden');
            setupPeer(); // Re-init default peer
        }

        function handleConnection(conn) {
            conn.on('open', () => {
                console.log(`Connected to ${conn.peer}`);
                connections[conn.peer] = conn;
                
                if (connectionMode === 'direct') {
                    showTransferWindow();
                } else if (connectionMode === 'room' && isHost) {
                    const peerIds = Object.keys(connections).filter(id => id !== conn.peer);
                    conn.send({ type: 'room-members', members: peerIds });
                    broadcast({ type: 'new-peer', peerId: conn.peer, deviceName: conn.metadata.deviceName }, conn.peer);
                }
                updatePeerListUI();
            });

            conn.on('data', (data) => handleData(data, conn));
            conn.on('close', () => {
                console.log(`Connection closed with ${conn.peer}`);
                 if (connectionMode === 'direct') {
                    showNotification("Peer disconnected.", "info");
                    leave();
                } else if (connectionMode === 'room') {
                    if (!isHost && conn.peer === roomCode) { // Host disconnected
                        showNotification("Host has closed the room.", "warning");
                        leave();
                    } else { // A regular peer left
                        delete connections[conn.peer];
                        broadcast({ type: 'peer-left', peerId: conn.peer });
                        updatePeerListUI();
                    }
                }
            });
            conn.on('error', (err) => { console.error(`Connection error with ${conn.peer}:`, err); });
        }
        
        function kickPeer(peerIdToKick) {
            if (!isHost) return;
            const conn = connections[peerIdToKick];
            if (conn) {
                conn.send({ type: 'kicked' });
                setTimeout(() => conn.close(), 100); // Give time for message to send
            }
        }
        
        // --- DATA ROUTER & BROADCASTING ---
        function handleData(data, conn) {
            console.log(`Received data from ${conn.peer}:`, data);
            if (!data || typeof data !== 'object') return receiveChunk(data, conn);

             switch(data.type) {
                case 'kicked': showNotification("You were kicked from the room.", "warning"); leave(); break;
                case 'room-members': data.members.forEach(id => handleConnection(peer.connect(id, {metadata:{deviceName:myDeviceName}}))); showTransferWindow(); break;
                case 'new-peer': handleConnection(peer.connect(data.peerId, {metadata:{deviceName:myDeviceName}})); break;
                case 'peer-left': if(connections[data.peerId]) { connections[data.peerId].close(); delete connections[data.peerId]; updatePeerListUI(); } break;
                case 'file-request': handleFileRequest(data, conn); break;
                case 'file-accepted': handleFileAccepted(data, conn); break;
                case 'file-rejected': console.log(`File rejected by ${conn.peer}`); break;
                case 'chat-message': displayChatMessage(data); break;
            }
        }

        function broadcast(data, excludePeerId = null) {
            Object.keys(connections).forEach(id => {
                if (id !== excludePeerId) connections[id].send(data);
            });
        }
        
        // --- FILE TRANSFER ---
        function queueFilesForTransfer(files) {
            if (!files || files.length === 0) return;
            if (Object.keys(connections).length === 0) return showNotification("No one is connected!", "warning");

            for (const file of files) {
                const transferId = `transfer_${Date.now()}_${Math.random()}`;
                fileSendQueue.push({ id: transferId, file, senderId: myPeerId, senderName: myDeviceName });
            }
            updateFileQueueUI();
            if (!currentSendTransfer) processSendQueue();
        }

        function processSendQueue() {
            if (currentSendTransfer || fileSendQueue.length === 0) return;
            currentSendTransfer = fileSendQueue[0];
            updateFileQueueUI();
            const payload = { type: 'file-request', id: currentSendTransfer.id, name: currentSendTransfer.file.name, size: currentSendTransfer.file.size, fileType: currentSendTransfer.file.type, senderId: myPeerId, senderName: myDeviceName };
            broadcast(payload);
        }
        
        function handleFileAccepted(data, conn) {
            if (!currentSendTransfer || currentSendTransfer.id !== data.id) return;
            sendFile(currentSendTransfer, conn);
        }

        function sendFile(transfer, connection) {
            const { file, id } = transfer;
            let chunkIndex = 0;
            const CHUNK_SIZE = 262144;
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            let startTime = Date.now();
            let bytesSent = 0;

            const sendNextChunk = () => {
                if (chunkIndex >= totalChunks) {
                    // This logic is simplified; in a real-world scenario, you'd track completion per-user.
                    fileSendQueue.shift(); 
                    currentSendTransfer = null;
                    updateFileQueueUI();
                    processSendQueue();
                    return;
                }
                const start = chunkIndex * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, file.size);
                
                file.slice(start, end).arrayBuffer().then(chunk => {
                    try {
                        connection.send(chunk);
                        bytesSent += chunk.byteLength;
                        const progress = (bytesSent / file.size) * 100;
                        const elapsed = (Date.now() - startTime) / 1000;
                        const speed = elapsed > 0 ? (bytesSent / 1024 / 1024) / elapsed : 0;
                        const status = connectionMode === 'direct' ? 'Sending...' : `Sending to ${connection.metadata.deviceName || 'peer'}`;
                        updateTransferProgressUI(id, { progress, speed, status });
                        chunkIndex++;
                        setTimeout(sendNextChunk, 0);
                    } catch (err) { console.error('Error sending chunk:', err); }
                });
            };
            sendNextChunk();
        }

        function handleFileRequest(metadata, conn) {
            if (metadata.senderId === myPeerId) return;
            receiveFileTransfer = { metadata, conn, chunks: [], receivedSize: 0, accepted: false };
            document.getElementById('fileReceiveSubtext').textContent = connectionMode === 'direct' ? 'A peer wants to send you a file:' : 'A peer in the room wants to send a file:';
            document.getElementById('fileReceiveName').textContent = metadata.name;
            document.getElementById('fileReceiveSize').textContent = formatBytes(metadata.size);
            document.getElementById('fileReceiveFrom').textContent = 'From: ' + metadata.senderName;
            const ext = metadata.name.split('.').pop().toLowerCase();
            const iconMap = { 'jpg': 'fa-file-image', 'png': 'fa-file-image', 'pdf': 'fa-file-pdf', 'zip': 'fa-file-zipper', 'mp4': 'fa-file-video', 'mp3': 'fa-file-audio' };
            document.getElementById('fileReceiveIcon').className = `fas ${iconMap[ext] || 'fa-file'} text-3xl text-blue-600`;
            document.getElementById('fileReceiveModal').classList.add('show');
            playSound('request');
        }

        function acceptFile() {
            document.getElementById('fileReceiveModal').classList.remove('show');
            if (receiveFileTransfer) {
                receiveFileTransfer.accepted = true;
                receiveFileTransfer.startTime = Date.now();
                receiveFileTransfer.conn.send({ type: 'file-accepted', id: receiveFileTransfer.metadata.id });
                addTransferToQueueUI(receiveFileTransfer.metadata.id, receiveFileTransfer.metadata.name);
            }
        }

        function declineFile() {
            document.getElementById('fileReceiveModal').classList.remove('show');
            if (receiveFileTransfer) receiveFileTransfer.conn.send({ type: 'file-rejected', id: receiveFileTransfer.metadata.id });
            receiveFileTransfer = null;
        }
        
        // BUG FIX #2: Robustly handle different data types for file chunks.
        function receiveChunk(data, conn) {
            if (!receiveFileTransfer || !receiveFileTransfer.accepted || conn.peer !== receiveFileTransfer.metadata.senderId) return;
            
            const processChunk = (arrayBuffer) => {
                receiveFileTransfer.chunks.push(arrayBuffer);
                receiveFileTransfer.receivedSize += arrayBuffer.byteLength;
                const progress = (receiveFileTransfer.receivedSize / receiveFileTransfer.metadata.size) * 100;
                const elapsed = (Date.now() - receiveFileTransfer.startTime) / 1000;
                const speed = elapsed > 0 ? (receiveFileTransfer.receivedSize / 1024 / 1024) / elapsed : 0;
                updateTransferProgressUI(receiveFileTransfer.metadata.id, { progress, speed, status: 'Receiving' });
                if (receiveFileTransfer.receivedSize >= receiveFileTransfer.metadata.size) {
                    completeFileReceive();
                }
            };

            if (data instanceof Blob) {
                data.arrayBuffer().then(processChunk);
            } else if (data instanceof ArrayBuffer) {
                processChunk(data);
            } else if (data.buffer instanceof ArrayBuffer) { // For Uint8Array and other typed arrays
                processChunk(data.buffer);
            }
        }

        function completeFileReceive() {
            if (!receiveFileTransfer) return;
            const { metadata, chunks } = receiveFileTransfer;
            try {
                const blob = new Blob(chunks, { type: metadata.fileType });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = metadata.name;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                updateTransferProgressUI(metadata.id, { status: 'Completed!' });
                playSound('complete');
                receiveFileTransfer = null;
            } catch (e) { console.error('Error completing file receive:', e); playSound('error'); }
        }
        
        // --- CHAT ---
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                const payload = { type: 'chat-message', content: message, senderName: myDeviceName };
                broadcast(payload);
                displayChatMessage(payload, true);
                input.value = '';
            }
        }

        function displayChatMessage(data, isSent = false) {
            if (isSent && data.senderName !== myDeviceName || !isSent && data.senderName === myDeviceName) return;
            const messagesDiv = document.getElementById('chatMessages');
            const wrapper = document.createElement('div');
            wrapper.className = `flex flex-col ${isSent ? 'items-end' : 'items-start'}`;
            if (connectionMode === 'room') {
                const name = document.createElement('span');
                name.className = 'text-xs text-slate-500 mb-1';
                name.textContent = isSent ? 'You' : data.senderName;
                wrapper.appendChild(name);
            }
            const bubble = document.createElement('div');
            bubble.className = `p-2 rounded-lg max-w-xs break-words ${isSent ? 'chat-bubble-sent' : 'chat-bubble-received'}`;
            bubble.textContent = data.content;
            wrapper.appendChild(bubble);
            messagesDiv.appendChild(wrapper);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            if(!isSent) playSound('chat');
        }

        // --- QR CODE ---
        function showMyIdQr() {
            document.getElementById('qrModalTitle').textContent = 'Your Direct ID';
            const container = document.getElementById('qrcodeContainer');
            container.innerHTML = '';
            new QRCode(container, { text: myPeerId, width: 256, height: 256 });
            document.getElementById('qrCodeText').textContent = myPeerId;
            document.getElementById('qrModal').classList.add('show');
        }
        
        function showRoomQr() {
            document.getElementById('qrModalTitle').textContent = 'Room Code';
            const container = document.getElementById('qrcodeContainer');
            container.innerHTML = '';
            new QRCode(container, { text: roomCode, width: 256, height: 256 });
            document.getElementById('qrCodeText').textContent = roomCode;
            document.getElementById('qrModal').classList.add('show');
        }
        
        function closeQR() { document.getElementById('qrModal').classList.remove('show'); }

        function openQRScanner(mode) {
            qrScannerMode = mode;
            document.getElementById('qrScannerTitle').textContent = `Scan ${mode === 'direct' ? 'Peer' : 'Room'} QR Code`;
            document.getElementById('qrScannerModal').classList.add('show');
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: {width: 250, height: 250} }, (decodedText) => {
                if (qrScannerMode === 'direct') {
                    document.getElementById('remotePeerIdInput').value = decodedText;
                    closeQRScanner();
                    connectToPeer();
                } else {
                    document.getElementById('roomCodeInput').value = decodedText;
                    closeQRScanner();
                    joinRoom();
                }
            }).catch(err => { console.error("QR Scanner error:", err); showNotification("Camera error.", 'error'); closeQRScanner(); });
        }

        function closeQRScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Error stopping scanner:", err));
            }
            html5QrCode = null;
            document.getElementById('qrScannerModal').classList.remove('show');
        }
        
        // --- UI & UTILITY ---
        function loadDeviceName() {
            myDeviceName = localStorage.getItem('deviceName') || 'Device-' + Math.random().toString(36).substr(2, 4);
            document.getElementById('deviceNameInput').value = myDeviceName;
        }

        function saveDeviceName() {
            const name = document.getElementById('deviceNameInput').value.trim();
            if (name) {
                myDeviceName = name;
                localStorage.setItem('deviceName', name);
                showNotification('Device name saved!', 'success');
            }
        }

        function showTransferWindow() {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('transferWindow').classList.remove('hidden');
            const header = document.getElementById('transferHeader');
            const peerListContainer = document.getElementById('peerListContainer');
            
            if (connectionMode === 'direct') {
                const remotePeer = Object.values(connections)[0];
                header.innerHTML = `
                    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <div class="bg-white text-purple-600 w-16 h-16 rounded-full flex items-center justify-center"><i class="fas fa-user text-3xl"></i></div>
                            <div>
                                <h2 class="text-xl md:text-2xl font-bold">Connected to ${remotePeer.metadata.deviceName}</h2>
                                <p class="text-xs opacity-75 font-mono">${remotePeer.peer}</p>
                            </div>
                        </div>
                        <button onclick="leave()" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600"><i class="fas fa-times mr-2"></i>Disconnect</button>
                    </div>`;
                peerListContainer.classList.add('hidden');
                document.getElementById('sendFileTitle').innerHTML = '<i class="fas fa-paper-plane text-purple-600 mr-2"></i>Send Files';
                document.getElementById('chatTitle').innerHTML = '<i class="fas fa-comments text-green-600 mr-2"></i>Direct Chat';
            } else if (connectionMode === 'room') {
                 header.innerHTML = `
                    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                             <div class="bg-white text-blue-600 w-16 h-16 rounded-full flex items-center justify-center"><i class="fas fa-users text-3xl"></i></div>
                            <div>
                                <h2 class="text-xl md:text-2xl font-bold">Room Code: <span class="font-mono">${roomCode}</span></h2>
                                <p class="text-sm opacity-90">Your Name: ${myDeviceName}</p>
                            </div>
                        </div>
                         <div class="flex gap-2">
                            <button onclick="copyRoomCode()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600"><i class="fas fa-copy mr-2"></i>Copy Code</button>
                            <button onclick="showRoomQr()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600"><i class="fas fa-qrcode mr-2"></i>Show QR</button>
                            <button onclick="leave()" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600"><i class="fas fa-door-open mr-2"></i>Leave Room</button>
                        </div>
                    </div>`;
                peerListContainer.classList.remove('hidden');
                document.getElementById('sendFileTitle').innerHTML = '<i class="fas fa-paper-plane text-blue-600 mr-2"></i>Send Files to Room';
                document.getElementById('chatTitle').innerHTML = '<i class="fas fa-comments text-green-600 mr-2"></i>Room Chat';
            }
            setupFileInputs();
        }

        function updatePeerListUI() {
            if (connectionMode !== 'room') return;
            const peerListDiv = document.getElementById('peerList');
            let html = `<div class="p-2 bg-blue-50 rounded-lg text-sm font-bold text-blue-700">${myDeviceName} (You)</div>`;
            const peerIds = Object.keys(connections);
            if (peerIds.length === 0) {
                 peerListDiv.innerHTML = html + '<p class="text-xs text-slate-400 text-center py-2">You are alone in this room.</p>';
                 return;
            }
            peerIds.forEach(id => {
                const conn = connections[id];
                if (!conn) return;
                const name = conn.metadata.deviceName || 'Unknown';
                const kickButton = isHost ? `<button onclick="kickPeer('${id}')" class="text-red-500 hover:text-red-700 text-xs font-bold">Kick</button>` : '';
                html += `<div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg text-sm text-slate-700"><span>${name}</span> ${kickButton}</div>`;
            });
            peerListDiv.innerHTML = html;
        }

        function setupFileInputs() {
            const dropZone = document.getElementById('dropZone');
            const newDropZone = dropZone.cloneNode(true);
            dropZone.parentNode.replaceChild(newDropZone, dropZone);
            newDropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); newDropZone.classList.add('border-blue-500', 'bg-blue-50'); });
            newDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); newDropZone.classList.remove('border-blue-500', 'bg-blue-50'); });
            newDropZone.addEventListener('drop', (e) => {
                e.preventDefault(); e.stopPropagation();
                newDropZone.classList.remove('border-blue-500', 'bg-blue-50');
                if (e.dataTransfer.files.length > 0) queueFilesForTransfer(e.dataTransfer.files);
            });
            document.getElementById('fileInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) queueFilesForTransfer(e.target.files);
                e.target.value = '';
            });
        }
        
        function updateConnectionStatus(text, color) {
            const status = document.getElementById('connectionStatus');
            const colors = { 'green': 'text-green-600', 'red': 'text-red-600', 'orange': 'text-orange-600', 'gray': 'text-slate-500' };
            status.innerHTML = `<i class="fas fa-circle ${colors[color] || 'text-gray-400'} ${color === 'green' ? 'online' : ''} mr-1"></i>${text}`;
        }
        
        function updateFileQueueUI() {
            const queueDiv = document.getElementById('fileQueue');
            const activeTransfers = document.querySelectorAll('[id^="transfer-progress-"]');
            if(fileSendQueue.length === 0 && activeTransfers.length === 0) {
                queueDiv.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">No active transfers</p>';
            }
            fileSendQueue.forEach(item => {
                if (!document.getElementById(`transfer-progress-${item.id}`)) addTransferToQueueUI(item.id, item.file.name, true);
            });
        }
        
        function addTransferToQueueUI(id, fileName, isSender = false) {
             const queueDiv = document.getElementById('fileQueue');
             if(queueDiv.querySelector('p')) queueDiv.innerHTML = '';
             const el = document.createElement('div');
             el.id = `transfer-progress-${id}`;
             el.innerHTML = `
                <div class="bg-slate-100 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-700 truncate" title="${fileName}">${fileName}</span>
                        <span id="transferPercent-${id}" class="text-sm font-medium text-blue-600">0%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2"><div id="transferProgressBar-${id}" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div></div>
                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                        <span id="transferSpeed-${id}">0 MB/s</span>
                        <span id="transferStatus-${id}">${isSender ? 'Offering...' : 'Waiting...'}</span>
                    </div>
                </div>`;
            queueDiv.appendChild(el);
        }

        function updateTransferProgressUI(id, {progress, speed, status}) {
            const percentEl = document.getElementById(`transferPercent-${id}`);
            if(!percentEl) return; // Element might have been removed
            if (typeof progress !== 'undefined') {
                percentEl.textContent = Math.round(progress) + '%';
                document.getElementById(`transferProgressBar-${id}`).style.width = progress + '%';
            }
            if (typeof speed !== 'undefined') document.getElementById(`transferSpeed-${id}`).textContent = speed.toFixed(2) + ' MB/s';
            if (typeof status !== 'undefined') document.getElementById(`transferStatus-${id}`).textContent = status;
            if (status === 'Completed!') {
                setTimeout(() => document.getElementById(`transfer-progress-${id}`)?.remove(), 3000);
            }
        }

        function copyMyId() { navigator.clipboard.writeText(myPeerId).then(() => showNotification('Direct ID copied!', 'success')); }
        function copyRoomCode() { navigator.clipboard.writeText(roomCode).then(() => showNotification('Room code copied!', 'success')); }
        function formatBytes(b) { if (b === 0) return '0 Bytes'; const k=1024,s=['B','KB','MB','GB'],i=Math.floor(Math.log(b)/Math.log(k)); return `${parseFloat((b/Math.pow(k,i)).toFixed(2))} ${s[i]}`; }
        function showNotification(m,t){const c={s:'bg-green-100 text-green-700 border-green-500',e:'bg-red-100 text-red-700 border-red-500',w:'bg-yellow-100 text-yellow-700 border-yellow-500',i:'bg-blue-100 text-blue-700 border-blue-500'},i={s:'check',e:'exclamation',w:'info',i:'info'},n=document.createElement('div');n.className=`fixed top-4 right-4 ${c[t[0]]} border-l-4 p-4 rounded-lg shadow-lg z-50`;n.innerHTML=`<div class="flex items-center"><i class="fas fa-${i[t[0]]}-circle text-xl mr-3"></i><p>${m}</p></div>`;document.body.appendChild(n);setTimeout(()=>n.remove(),3e3)}
        function playSound(t){if(!audioContext)return;const o=audioContext.createOscillator(),g=audioContext.createGain();o.connect(g);g.connect(audioContext.destination);const s={c:{f:440,d:0.1,t:'sine'},d:{f:220,d:0.1,t:'sawtooth'},r:{f:660,d:0.2,t:'triangle'},f:{f:880,d:0.3,t:'sine'},e:{f:110,d:0.5,t:'square'},m:{f:550,d:0.05,t:'sine'}},d=s[t[0]];if(!d)return;o.type=d.t;o.frequency.setValueAtTime(d.f,audioContext.currentTime);g.gain.setValueAtTime(0.3,audioContext.currentTime);g.gain.exponentialRampToValueAtTime(1e-4,audioContext.currentTime+d.d);o.start();o.stop(audioContext.currentTime+d.d)}
        document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });
        
        window.addEventListener('load', initialize);
    </script>
</body>
</html>

